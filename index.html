<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°çƒOLï¼šæˆ‘çš„è§’è‰²æ‰‹å†Œ</title>
    
    <!-- å¼•å…¥ Tailwind CSS é…ç½® (å¿…é¡»åœ¨åŠ è½½ CDN è„šæœ¬ä¹‹å‰) -->
    <script>
        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šå°†æ‰€æœ‰é…ç½®åˆå¹¶åˆ°ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ window.tailwindConfig
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {
            // å¯ç”¨æš—é»‘æ¨¡å¼æ”¯æŒ
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#1f2937',
                        'accent': '#10b981',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'sans-serif'],
                    }
                }
            }
        };
    </script>
    
    <!-- CRITICAL FIX: æ ·å¼å’Œ CDN å¿…é¡»åœ¨ä¸»è„šæœ¬ä¹‹å‰ï¼Œä½† CSS åº”è¯¥åœ¨ Tailwind CDN ä¹‹å‰ -->
    <style>
        /* å¼ºåˆ¶ä½¿ç”¨ Inter å’Œä¸­æ–‡å­—ä½“ */
        body { 
            font-family: 'Inter', 'Noto Sans SC', sans-serif; 
            /* FIX: é˜²æ­¢ä»»ä½•å…ƒç´ åœ¨ x è½´ä¸Šæº¢å‡ºï¼Œé¿å…å¸ƒå±€é”™ä¹± */
            overflow-x: hidden;
            transition: background-color 0.3s;
        }
        
        /* ä¿®å¤é¡µé¢æ•´ä½“æ ·å¼ */
        .max-w-4xl {
            max-width: 56rem;
            margin-left: auto;
            margin-right: auto;
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ (æ·±è‰²æ¨¡å¼) */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        
        /* âš ï¸ CRITICAL FIX: Markdown æ¸²æŸ“åçš„æ ·å¼ä¼˜åŒ– (å¼ºåˆ¶å¢åŠ å‚ç›´é—´è·) */
        .markdown-content > * {
            /* å¼ºåˆ¶å¢åŠ æ®µè½å’Œå—çº§å…ƒç´ çš„é—´è· */
            margin-top: 1rem !important; 
            margin-bottom: 1rem !important;
            line-height: 1.6;
        }
        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5rem;
            padding-left: 0;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .markdown-content ul {
            list-style-type: disc;
        }
        .markdown-content ol {
            list-style-type: decimal;
        }
        .markdown-content li {
            /* å¼ºåˆ¶å¢åŠ åˆ—è¡¨é¡¹é—´è· */
            margin-bottom: 0.6rem !important;
        }
        .markdown-content strong {
            font-weight: 700;
        }
        
        /* è½®æ’­å›¾å®¹å™¨çš„è‡ªå®šä¹‰æ ·å¼ (FIXED: é’ˆå¯¹ 2 å¼ å›¾) */
        .carousel-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem; /* rounded-xl */
        }
        .carousel-track {
            display: flex;
            transition: transform 0.3s ease-in-out;
            width: 200%; /* 2 slides * 100% */
        }
        .carousel-slide {
            flex-shrink: 0;
            width: calc(100% / 2); /* 100% / 2 slides */
            /* FIX: ç¡®ä¿ slide å æ®å®Œæ•´é«˜åº¦ */
            height: 100%; 
        }
        .carousel-slide img {
             /* FIX: ç¡®ä¿å›¾ç‰‡å æ® slide å®Œæ•´é«˜åº¦ */
            height: 100%; 
        }
        .carousel-control {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.4);
            color: white;
            padding: 0.5rem;
            cursor: pointer;
            z-index: 10;
            border-radius: 9999px; /* rounded-full */
        }

        /* NEW UX: æŠ˜å é¢æ¿è¿‡æ¸¡åŠ¨ç”» */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .collapsible-content.active {
            max-height: 1000px; /* å¿…é¡»è®¾ç½®ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å€¼ */
        }

        /* NEW UX: è§’è‰²å¡ç‰‡é˜´å½±é«˜äº® */
        #fantasy-role-card {
             box-shadow: 0 0 15px rgba(79, 70, 229, 0.4); /* Primary color shadow */
        }
        #realistic-role-card {
             box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); /* Accent color shadow */
        }
        
        /* é’ˆå¯¹è¡ŒåŠ¨è®¡åˆ’åˆ—è¡¨çš„ä¿®æ­£ */
        #plan-list li {
            list-style: none !important; /* å¼ºåˆ¶ç§»é™¤ Markdown äº§ç”Ÿçš„é»˜è®¤åˆ—è¡¨ç‚¹ */
            margin-bottom: 1rem !important; /* å¼ºåˆ¶å¢åŠ è¡Œé—´è· */
        }

        /* é€‚é…åº¦è¿›åº¦æ¡åŠ¨ç”» */
        .progress-bar {
            transition: width 1s ease-out;
        }
        
        /* é¡µé¢åˆ‡æ¢çš„ CSS åŸºç¡€ */
        .page-inactive {
            display: none !important; 
            opacity: 0; 
            pointer-events: none;
        }
    </style>
    <!-- å¼•å…¥ Tailwind CSS CDN è„šæœ¬ (åœ¨é…ç½®å’Œè‡ªå®šä¹‰æ ·å¼ä¹‹å) -->
    <!-- ç›´æ¥ä½¿ç”¨å†…è”å¤‡ç”¨æ ·å¼ï¼Œç¡®ä¿é¡µé¢å§‹ç»ˆæœ‰æ ·å¼ -->
    <style id="backup-tailwind-styles">
        .bg-gray-900 { background-color: #111827; }
        .text-gray-100 { color: #f3f4f6; }
        .p-4 { padding: 1rem; }
        .p-8 { padding: 2rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .border { border-width: 1px; }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .w-full { width: 100%; }
        .w-6 { width: 1.5rem; }
        .h-6 { height: 1.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .text-xl { font-size: 1.25rem; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .space-x-3 > * + * { margin-left: 0.75rem; }
        .transition { transition-property: all; transition-duration: 150ms; }
        .hover\:bg-gray-600:hover { background-color: #4b5563; }
        .hover\:bg-blue-500:hover { background-color: #3b82f6; }
        .hover\:bg-green-500:hover { background-color: #22c55e; }
        .hover\:bg-purple-500:hover { background-color: #a855f7; }
        .hover\:text-white:hover { color: #ffffff; }
        .bg-blue-600 { background-color: #2563eb; }
        .bg-green-600 { background-color: #16a34a; }
        .bg-purple-600 { background-color: #9333ea; }
        .bg-gray-700 { background-color: #374151; }
        .bg-gray-800 { background-color: #1f2937; }
        .bg-yellow-900\/30 { background-color: rgba(113, 63, 18, 0.3); }
        .border-gray-600 { border-color: #4b5563; }
        .border-yellow-600\/50 { border-color: rgba(202, 138, 4, 0.5); }
        .text-white { color: #ffffff; }
        .text-red-400 { color: #f87171; }
        .text-green-400 { color: #4ade80; }
        .text-blue-400 { color: #60a5fa; }
        .text-yellow-400 { color: #facc15; }
        .text-yellow-300 { color: #fde047; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-300 { color: #d1d5db; }
        .text-blue-300 { color: #93c5fd; }
        .text-green-300 { color: #86efac; }
        .text-red-300 { color: #fca5a5; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-1 { padding-left: 0.25rem; padding-right: 0.25rem; }
        .rounded { border-radius: 0.25rem; }
        .cursor-pointer { cursor: pointer; }
        .min-h-screen { min-height: 100vh; }
        .max-w-4xl { max-width: 56rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .flex-1 { flex: 1 1 0%; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .top-4 { top: 1rem; }
        .right-4 { right: 1rem; }
        .z-50 { z-index: 50; }
        .opacity-0 { opacity: 0; }
        .pointer-events-none { pointer-events: none; }
        .focus\:ring-blue-500:focus { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); }
        .focus\:border-blue-500:focus { border-color: #3b82f6; }
        .disabled\:opacity-50:disabled { opacity: 0.5; }
        .disabled\:cursor-not-allowed:disabled { cursor: not-allowed; }
        button { padding: 0.5rem 1rem; border-radius: 0.75rem; border: none; cursor: pointer; }
        input, textarea { padding: 0.75rem; border-radius: 0.75rem; border: 1px solid #4b5563; background-color: #374151; color: #f3f4f6; }
        input:focus, textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); }
    </style>
    
    <!-- å®Œå…¨è‡ªåŒ…å«çš„æ ·å¼æ–¹æ¡ˆï¼Œä¸ä¾èµ–ä»»ä½•å¤–éƒ¨CDN -->
    <script>
        console.log('ä½¿ç”¨å®Œå…¨è‡ªåŒ…å«çš„æ ·å¼æ–¹æ¡ˆï¼Œæ— éœ€å¤–éƒ¨CDN');
    </script>
    
    <!-- å†…è”ç®€åŒ–Markdownè§£æå™¨ï¼Œæ›¿ä»£marked.js CDN -->
    <script>
        // ç®€åŒ–çš„Markdownè§£æå™¨ï¼Œæ”¯æŒåŸºæœ¬æ ¼å¼
        const marked = {
            parse: function(text) {
                if (!text) return '';
                
                return text
                    // ç²—ä½“ **text** æˆ– __text__
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/__(.*?)__/g, '<strong>$1</strong>')
                    // æ–œä½“ *text* æˆ– _text_
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/_(.*?)_/g, '<em>$1</em>')
                    // ä»£ç  `code`
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    // é“¾æ¥ [text](url)
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
                    // æ¢è¡Œ
                    .replace(/\n/g, '<br>')
                    // æ ‡é¢˜ # ## ###
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                    // åˆ—è¡¨é¡¹ - item æˆ– * item
                    .replace(/^\s*[-*]\s+(.*$)/gim, '<li>$1</li>')
                    // åŒ…è£…è¿ç»­çš„liä¸ºul
                    .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                    // æ¸…ç†å¤šä½™çš„ulæ ‡ç­¾
                    .replace(/<\/ul>\s*<ul>/g, '');
            }
        };
        
        console.log('å†…è”Markdownè§£æå™¨å·²åŠ è½½');
    </script>
    
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8" data-theme="dark">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-primary mb-2">ğŸŒ åœ°çƒOLï¼šæˆ‘çš„è§’è‰²æ‰‹å†Œ</h1>
            <p class="text-xl text-gray-400">è¾“å…¥ä½ çš„"è§’è‰²å±æ€§"ï¼Œè·å–ä¸“å±æˆé•¿æ”»ç•¥ï¼</p>
        </header>
        
        <!-- NEW: ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
        <button id="theme-toggle-btn" onclick="toggleTheme()" class="fixed top-4 right-4 z-50 p-3 rounded-full bg-gray-700 text-white shadow-lg hover:bg-gray-600 transition duration-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
        </button>

        <!-- NEW: APIå¯†é’¥è®¾ç½®æŒ‰é’® -->
        <button id="api-settings-btn" onclick="toggleApiSettings()" class="fixed top-4 right-20 z-50 p-3 rounded-full bg-blue-600 text-white shadow-lg hover:bg-blue-500 transition duration-300" title="APIå¯†é’¥è®¾ç½®">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
        </button>

        <!-- NEW: APIå¯†é’¥è®¾ç½®é¢æ¿ (é»˜è®¤éšè—) -->
        <div id="api-settings-panel" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-gray-800 rounded-2xl shadow-2xl border border-gray-600 w-full max-w-md">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-white">APIå¯†é’¥è®¾ç½®</h3>
                            <button onclick="toggleApiSettings()" class="text-gray-400 hover:text-white transition duration-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-2">
                                    Google AI Studio APIå¯†é’¥
                                </label>
                                <input 
                                    type="password" 
                                    id="api-key-input" 
                                    placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥ (gen-lang-client-...)" 
                                    class="w-full bg-gray-700 border border-gray-600 text-gray-100 p-3 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                >
                                <div id="api-key-status" class="mt-2 text-sm"></div>
                            </div>
                            
                            <div class="bg-gray-700 p-4 rounded-xl">
                                <h4 class="text-sm font-medium text-gray-300 mb-2">ğŸ“‹ è·å–APIå¯†é’¥æ­¥éª¤ï¼š</h4>
                                <ol class="text-xs text-gray-400 space-y-1">
                                    <li>1. è®¿é—® <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 hover:text-blue-300">Google AI Studio</a></li>
                                    <li>2. åˆ›å»ºæ–°çš„APIå¯†é’¥</li>
                                    <li>3. é€‰æ‹©"æµè§ˆå™¨å¯†é’¥"ç±»å‹</li>
                                    <li>4. åœ¨å…è®¸åŸŸåä¸­æ·»åŠ ï¼š<code id="current-domain" class="bg-gray-600 px-1 rounded text-xs"></code></li>
                                    <li>5. å¤åˆ¶å¯†é’¥å¹¶ç²˜è´´åˆ°ä¸Šæ–¹è¾“å…¥æ¡†</li>
                                </ol>
                                <div class="mt-3 p-2 bg-yellow-900/30 border border-yellow-600/50 rounded text-xs text-yellow-300">
                                    âš ï¸ é‡è¦ï¼šå¿…é¡»åœ¨Google AI Studioä¸­æ·»åŠ ä¸Šè¿°åŸŸåï¼Œå¦åˆ™APIè°ƒç”¨ä¼šè¢«æ‹’ç»
                                </div>
                            </div>
                            
                            <div class="flex space-x-2">
                                <button 
                                    id="test-api-key-btn" 
                                    onclick="testApiKey()" 
                                    class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 px-4 rounded-xl transition duration-200 text-sm"
                                >
                                    æµ‹è¯•è¿æ¥
                                </button>
                                <button 
                                    id="diagnose-api-btn" 
                                    onclick="diagnoseApiKey()" 
                                    class="bg-purple-600 hover:bg-purple-500 text-white py-2 px-3 rounded-xl transition duration-200 text-sm"
                                >
                                    è¯Šæ–­
                                </button>
                                <button 
                                    id="save-api-key-btn" 
                                    onclick="saveApiKey()" 
                                    class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2 px-4 rounded-xl transition duration-200 text-sm"
                                >
                                    ä¿å­˜å¯†é’¥
                                </button>
                            </div>
                            
                            <!-- è¯Šæ–­ä¿¡æ¯åŒºåŸŸ -->
                            <div id="api-diagnosis" class="mt-4 p-4 bg-gray-800 rounded-xl border border-gray-600 hidden">
                                <h4 class="text-sm font-medium text-gray-300 mb-3">ğŸ” APIå¯†é’¥è¯Šæ–­ä¿¡æ¯</h4>
                                <div id="diagnosis-content" class="text-xs text-gray-400 space-y-2">
                                    <!-- è¯Šæ–­å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¾“å…¥è¡¨å•åŒºåŸŸ (é»˜è®¤æ¿€æ´»ï¼Œä¸å¸¦ page-inactive) -->
        <div id="input-form-container" class="bg-secondary p-6 sm:p-8 rounded-2xl shadow-2xl border border-gray-700">
            <h2 class="text-2xl font-bold mb-6 border-b border-gray-700 pb-3">è§’è‰²å±æ€§ç‚¹åˆ†é…</h2>
            <form id="character-form" class="space-y-6">

                <!-- ç¬¬ä¸€è¡Œï¼šåŸºç¡€ä¿¡æ¯ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-300 mb-1">å§“å/è§’è‰²ä»£å·</label>
                        <input type="text" id="name" name="name" required aria-required="true" maxlength="30" 
                            class="w-full bg-gray-800 border border-gray-700 text-gray-100 p-3 rounded-xl focus:ring-primary focus:border-primary transition duration-150" 
                            placeholder="æå¯»æ¬¢" aria-label="å§“åæˆ–è§’è‰²ä»£å·">
                        <div id="name-error" class="text-red-500 text-xs mt-1 hidden"></div>
                    </div>
                    <div>
                        <label for="mbti" class="block text-sm font-medium text-gray-300 mb-1">MBTIäººæ ¼ç±»å‹</label>
                        <select id="mbti" name="mbti" required aria-required="true" aria-label="é€‰æ‹©MBTIäººæ ¼ç±»å‹" 
                            class="w-full bg-gray-800 border border-gray-700 text-gray-100 p-3 rounded-xl focus:ring-primary focus:border-primary transition duration-150">
                            <option value="" disabled selected>é€‰æ‹©ä½ çš„ç±»å‹...</option>
                            <option value="INFP">INFP (è°ƒåœè€…)</option>
                            <option value="ENFJ">ENFJ (ä¸»äººå…¬)</option>
                            <option value="ISTJ">ISTJ (ç‰©æµå¸ˆ)</option>
                            <option value="ESTP">ESTP (ä¼ä¸šå®¶)</option>
                            <option value="ENTJ">ENTJ (æŒ‡æŒ¥å®˜)</option>
                            <option value="ISFP">ISFP (æ¢é™©å®¶)</option>
                            <option value="INFJ">INFJ (æå€¡è€…)</option>
                            <option value="ESFJ">ESFJ (æ‰§æ”¿å®˜)</option>
                            <option value="INTP">INTP (é€»è¾‘å­¦å®¶)</option>
                            <option value="ENFP">ENFP (ç«é€‰è€…)</option>
                            <option value="ESTJ">ESTJ (æ€»ç»ç†)</option>
                            <option value="ISFJ">ISFJ (å®ˆæŠ¤è€…)</option>
                            <option value="ENTP">ENTP (è¾©è®ºå®¶)</option>
                            <option value="ISTP">ISTP (é‰´èµå®¶)</option>
                            <option value="ESFP">ESFP (è¡¨æ¼”è€…)</option>
                            <option value="INTJ">INTJ (å»ºç­‘å¸ˆ)</option>
                        </select>
                    </div>
                    <div>
                        <label for="zodiac" class="block text-sm font-medium text-gray-300 mb-1">æ˜Ÿåº§</label>
                        <select id="zodiac" name="zodiac" required class="w-full bg-gray-800 border border-gray-700 text-gray-100 p-3 rounded-xl focus:ring-primary focus:border-primary transition duration-150">
                            <option value="" disabled selected>é€‰æ‹©ä½ çš„æ˜Ÿåº§...</option>
                            <option value="ç™½ç¾Šåº§">ç™½ç¾Šåº§ (Aries)</option>
                            <option value="é‡‘ç‰›åº§">é‡‘ç‰›åº§ (Taurus)</option>
                            <option value="åŒå­åº§">åŒå­åº§ (Gemini)</option>
                            <option value="å·¨èŸ¹åº§">å·¨èŸ¹åº§ (Cancer)</option>
                            <option value="ç‹®å­åº§">ç‹®å­åº§ (Leo)</option>
                            <option value="å¤„å¥³åº§">å¤„å¥³åº§ (Virgo)</option>
                            <option value="å¤©ç§¤åº§">å¤©ç§¤åº§ (Libra)</option>
                            <option value="å¤©èåº§">å¤©èåº§ (Scorpio)</option>
                            <option value="å°„æ‰‹åº§">å°„æ‰‹åº§ (Sagittarius)</option>
                            <option value="æ‘©ç¾¯åº§">æ‘©ç¾¯åº§ (Capricorn)</option>
                            <option value="æ°´ç“¶åº§">æ°´ç“¶åº§ (Aquarius)</option>
                            <option value="åŒé±¼åº§">åŒé±¼åº§ ( Pisces )</option>
                        </select>
                    </div>
                </div>

                <!-- NEW: ä¼˜åŒ–åçš„è¿›é˜¶ä¿¡æ¯ -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- NEW: äººç”Ÿé˜¶æ®µ -->
                    <div>
                        <label for="life-stage" class="block text-sm font-medium text-gray-300 mb-1">å½“å‰äººç”Ÿé˜¶æ®µ</label>
                        <select id="life-stage" name="life-stage" required class="w-full bg-gray-800 border border-gray-700 text-gray-100 p-3 rounded-xl focus:ring-primary focus:border-primary transition duration-150">
                            <option value="" disabled selected>é€‰æ‹©é˜¶æ®µ...</option>
                            <option value="å­¦ç”Ÿ/å­¦æœ¯">å­¦ç”Ÿ/å­¦æœ¯</option>
                            <option value="èŒåœºæ–°äºº (1-3å¹´)">èŒåœºæ–°äºº (1-3å¹´)</option>
                            <option value="èµ„æ·±ä¸“ä¸šäººå£« (4å¹´ä»¥ä¸Š)">èµ„æ·±ä¸“ä¸šäººå£« (4å¹´ä»¥ä¸Š)</option>
                            <option value="å›¢é˜Ÿç®¡ç†è€…/é¢†å¯¼è€…">å›¢é˜Ÿç®¡ç†è€…/é¢†å¯¼è€…</option>
                            <option value="è‡ªç”±èŒä¸šè€…/ç‹¬ç«‹å·¥ä½œè€…">è‡ªç”±èŒä¸šè€…/ç‹¬ç«‹å·¥ä½œè€…</option>
                            <option value="åˆ›ä¸šè€…/å…¬å¸åˆ›å§‹äºº">åˆ›ä¸šè€…/å…¬å¸åˆ›å§‹äºº</option>
                        </select>
                    </div>
                    <div>
                        <label for="animal" class="block text-sm font-medium text-gray-300 mb-1">ç”Ÿè‚–</label>
                        <input type="text" id="animal" name="animal" class="w-full bg-gray-800 border border-gray-700 text-gray-100 p-3 rounded-xl focus:ring-primary focus:border-primary transition duration-150" placeholder="ä¾‹å¦‚ï¼šé¾™/å…” (é€‰å¡«)">
                    </div>
                    <div>
                        <label for="bazi" class="block text-sm font-medium text-gray-300 mb-1">å…«å­—/äººç±»å›¾ï¼ˆå…³é”®å­—ï¼‰</label>
                        <input type="text" id="bazi" name="bazi" class="w-full bg-gray-800 border border-gray-700 text-gray-100 p-3 rounded-xl focus:ring-primary focus:border-primary transition duration-150" placeholder="ä¾‹å¦‚ï¼šèº«å¼±/æŠ•å°„è€…/3/5çº¿ (é€‰å¡«)">
                    </div>
                    <!-- NEW: å†œå†ç”Ÿæ—¥ -->
                    <div>
                        <label for="lunar-birthday" class="block text-sm font-medium text-gray-300 mb-1">å†œå†ç”Ÿæ—¥ (å¹´/æœˆ/æ—¥/æ—¶)</label>
                        <input type="text" id="lunar-birthday" name="lunar-birthday" class="w-full bg-gray-800 border border-gray-700 text-gray-100 p-3 rounded-xl focus:ring-primary focus:border-primary transition duration-150" placeholder="ä¾‹å¦‚ï¼š1990å¹´ä¸ƒæœˆåäº”æ—¥è¾°æ—¶ (é€‰å¡«)">
                    </div>
                </div>

                <!-- NEW: å®æ—¶è‡ªè¯„é‡è¡¨ (FIXED: å¢åŠ æ„å¿—ï¼Œæ”¹ä¸º grid-cols-4) -->
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700" id="self-rating-card">
                    <label class="block text-sm font-bold text-primary mb-3">âš¡ å½“å‰ç²¾åŠ›å®æ—¶è‡ªè¯„ (1=æå·®, 5=æä½³)</label>
                    <div class="grid grid-cols-4 gap-4 text-center">
                        <div class="space-y-2">
                            <label for="self-physical" class="text-gray-300">ğŸ’ª ä½“èƒ½</label>
                            <input type="range" id="self-physical" name="self-physical" min="1" max="5" value="3" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                            <span id="self-physical-value" class="text-sm text-accent">3</span>
                        </div>
                        <div class="space-y-2">
                            <label for="self-emotional" class="text-gray-300">ğŸ’– æƒ…ç»ª</label>
                            <input type="range" id="self-emotional" name="self-emotional" min="1" max="5" value="3" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                            <span id="self-emotional-value" class="text-sm text-accent">3</span>
                        </div>
                        <div class="space-y-2">
                            <label for="self-mental" class="text-gray-300">ğŸ§  æ€ç»´</label>
                            <input type="range" id="self-mental" name="self-mental" min="1" max="5" value="3" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                            <span id="self-mental-value" class="text-sm text-accent">3</span>
                        </div>
                        <!-- NEW: æ„å¿— -->
                        <div class="space-y-2">
                            <label for="self-spiritual" class="text-gray-300">ğŸ”¥ æ„å¿—</label>
                            <input type="range" id="self-spiritual" name="self-spiritual" min="1" max="5" value="3" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                            <span id="self-spiritual-value" class="text-sm text-accent">3</span>
                        </div>
                    </div>
                </div>

                <!-- NEW: ç›–æ´›æ™®ä¼˜åŠ¿ä¸ç…§ç‰‡ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="strengths" class="block text-sm font-medium text-gray-300 mb-1">ç›–æ´›æ™®ä¼˜åŠ¿/æ ¸å¿ƒæŠ€èƒ½</label>
                        <input type="text" id="strengths" name="strengths" class="w-full bg-gray-800 border border-gray-700 text-gray-100 p-3 rounded-xl focus:ring-primary focus:border-primary transition duration-150" placeholder="ä¾‹å¦‚ï¼šæˆ˜ç•¥/æ€ç»´/å­¦ä¹  (é€‰å¡«)">
                    </div>
                    <div>
                        <label for="photo" class="block text-sm font-medium text-gray-300 mb-1">
                            ä¸Šä¼ ä½ çš„ç…§ç‰‡ä½œä¸ºè§’è‰²å½¢è±¡å‚è€ƒï¼ˆå¯é€‰ï¼‰
                        </label>
                        <input type="file" id="photo" name="photo" accept="image/*" class="w-full text-gray-300 file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0 file:text-sm file:font-semibold
                            file:bg-primary/20 file:text-primary hover:file:bg-primary/30
                            cursor-pointer transition duration-150">
                        <p id="photo-status" class="text-xs mt-2 text-gray-500">
                            ç…§ç‰‡ä»…ç”¨äºAIå‚è€ƒç”Ÿæˆå½¢è±¡ï¼Œä¸ä¼šè¢«å­˜å‚¨ã€‚
                        </p>
                    </div>
                </div>

                <!-- ç¬¬ä¸‰è¡Œï¼šä¸ªäººä»‹ç» -->
                <div>
                    <label for="intro" class="block text-sm font-medium text-gray-300 mb-1">ä¸ªäººä»‹ç»/å½“å‰å›°å¢ƒï¼ˆæœ€é‡è¦ï¼è¯·æè¿°å›°å¢ƒæˆ–ç›®æ ‡ï¼‰</label>
                    <textarea id="intro" name="intro" rows="4" required aria-required="true" maxlength="500" aria-label="ä¸ªäººä»‹ç»æˆ–å½“å‰å›°å¢ƒ" class="w-full bg-gray-800 border border-gray-700 text-gray-100 p-3 rounded-xl focus:ring-primary focus:border-primary transition duration-150" placeholder="è¯·æè¿°ä½ çš„å›°å¢ƒï¼šæ¯”å¦‚å·¥ä½œæ–¹å‘è¿·èŒ«ï¼Œæ¸´æœ›åˆ›æ–°ä½†ç¼ºä¹å‹‡æ°”..."></textarea>
                    <div id="intro-error" class="text-red-500 text-xs mt-1 hidden"></div>
                    <div class="text-gray-400 text-xs mt-1"><span id="intro-char-count">0</span>/500 å­—ç¬¦</div>
                </div>

                <button type="submit" id="submit-btn" class="w-full bg-primary hover:bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg transition duration-300 ease-in-out transform hover:scale-[1.01] flex items-center justify-center">
                    <svg id="submit-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944c-1.282 0-2.52.22-3.67.653m11.332 7.788c-.643 2.067-2.126 3.737-4.08 4.795-1.954 1.058-4.326 1.341-6.49 1.157M12 21a9 9 0 005.618-2.016c.928-.506 1.637-1.127 2.152-1.84M12 21a9 9 0 01-5.618-2.016c-.515-.713-1.224-1.334-2.152-1.84m-.336-10.741c.643-2.067 2.126-3.737 4.08-4.795 1.954-1.058 4.326-1.341 6.49-1.157"></path></svg>
                    ç”Ÿæˆæˆ‘çš„è§’è‰²æ‰‹å†Œ
                </button>
            </form>
        </div>

        <!-- åŠ è½½å’Œé”™è¯¯ä¿¡æ¯åŒºåŸŸ -->
        <div id="loading-area" class="mt-8 text-center hidden">
            <svg class="animate-spin h-8 w-8 text-primary mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-message" class="text-lg text-gray-400">æ­£åœ¨æ•´åˆæ˜Ÿç›˜ä¸å¤©èµ‹æ ‘ï¼Œè¯·ç¨å€™...</p>
            
            <!-- NEW: è¿›åº¦æ¡å®¹å™¨ -->
            <div class="w-full bg-gray-700 rounded-full h-2.5 mt-4">
                <div id="progress-bar" class="bg-primary h-2.5 rounded-full transition-all duration-500 ease-in-out" style="width: 0%"></div>
            </div>
            
            <p id="error-message" class="text-lg text-red-400 mt-2 hidden"></p>
        </div>

        <!-- ç»“æœå±•ç¤ºåŒºåŸŸ (FIXED: åˆå§‹æ·»åŠ  page-inactive ç±») -->
        <div id="result-card" class="mt-12 page-inactive">
            <!-- è§’è‰²å¡ç‰‡ (é¡¶éƒ¨) -->
            <div id="role-card-header" class="bg-gray-800 p-8 rounded-2xl shadow-3xl border border-primary/50 mb-8">
                <div class="md:flex gap-8 items-start">
                    <!-- NEW: è§’è‰²å½¢è±¡è½®æ’­å›¾ -->
                    <div class="flex-shrink-0 w-full md:w-1/3 mb-6 md:mb-0">
                        <div class="carousel-container aspect-square shadow-lg border-4 border-primary/30" id="image-carousel">
                            <div class="carousel-track h-full" id="carousel-track">
                                <!-- Slides will be injected here -->
                            </div>
                            <!-- å·¦ç®­å¤´ -->
                            <button class="carousel-control left-0 ml-2" onclick="moveSlide(-1)">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <!-- å³ç®­å¤´ -->
                            <button class="carousel-control right-0 mr-2" onclick="moveSlide(1)">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>

                        <!-- NEW: åŒè§’è‰²åç§°ä¸é€‚é…åº¦ -->
                        <div class="mt-6 space-y-4">
                            <!-- å¹»æƒ³è§’è‰² -->
                            <div id="fantasy-role-card" class="bg-gray-700 p-3 rounded-xl border border-primary/70">
                                <p class="text-xs text-primary font-bold">ğŸŒ å¹»æƒ³è§’è‰² (Earth OL Role)</p>
                                <h3 id="fantasy-role-name" class="text-2xl font-extrabold text-white mt-1">è§’è‰²å</h3>
                                <p id="fantasy-role-trait" class="text-sm text-gray-400">æ ¸å¿ƒç‰¹è´¨</p>
                                <div class="mt-3">
                                    <div class="flex justify-between mb-1 text-sm font-medium">
                                        <span class="text-primary">é€‚é…åº¦</span>
                                        <span id="fantasy-fit-percent" class="text-primary">0%</span>
                                    </div>
                                    <div class="w-full bg-gray-600 rounded-full h-2">
                                        <div id="fantasy-fit-bar" class="bg-primary h-2 rounded-full progress-bar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- ç°å®è§’è‰² -->
                            <div id="realistic-role-card" class="bg-gray-700 p-3 rounded-xl border border-accent/70">
                                <p class="text-xs text-accent font-bold">ğŸ’¼ ç°å®èº«ä»½ (Real-World Persona)</p>
                                <h3 id="realistic-role-name" class="text-2xl font-extrabold text-white mt-1">ç°å®èº«ä»½</h3>
                                <div class="mt-3">
                                    <div class="flex justify-between mb-1 text-sm font-medium">
                                        <span class="text-accent">é€‚é…åº¦</span>
                                        <span id="realistic-fit-percent" class="text-accent">0%</span>
                                    </div>
                                    <div class="w-full bg-gray-600 rounded-full h-2">
                                        <div id="realistic-fit-bar" class="bg-accent h-2 rounded-full progress-bar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è§’è‰²æè¿°ä¸é‡‘å¥ -->
                    <div class="flex-grow">
                        <h4 class="text-xl font-bold text-primary mb-3 border-b border-gray-700 pb-2">è§’è‰²æè¿°ï¼ˆEarth OL Level 1ï¼‰</h4>
                        <!-- FIX 2a: è°ƒæ•´è§’è‰²æè¿°åˆå§‹é¢œè‰²ï¼Œä½¿ç”¨é«˜å¯¹æ¯”åº¦ç±» -->
                        <div id="role-description-display" class="markdown-content text-gray-200 leading-relaxed mb-6">è§’è‰²æè¿°å†…å®¹...</div>
                        
                        <div id="golden-sentence-card" class="bg-gray-700/50 p-4 rounded-xl border border-gray-600">
                            <!-- FIX 1: æ–‡æœ¬æ›¿æ¢ -->
                            <p class="text-sm font-semibold text-accent mb-1">ğŸ’¡ äººç”Ÿå¯„è¯­</p>
                            <!-- FIX 2b: è°ƒæ•´å¯„è¯­åˆå§‹é¢œè‰² -->
                            <blockquote id="golden-sentence-display" class="markdown-content text-gray-100 italic border-l-4 border-accent pl-3">é‡‘å¥å†…å®¹...</blockquote>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ”»ç•¥æ‰‹å†Œ (æŠ˜å é¢æ¿) -->
            <div id="guidance-sections" class="space-y-6 mb-6">
                
                <!-- 1. NLP å…­å±‚æŒ‡å¼• -->
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700" id="nlp-card">
                    <button class="flex justify-between items-center w-full focus:outline-none" onclick="toggleSection('nlp-content', 'nlp-toggle')">
                        <h4 class="2xl font-bold text-indigo-400">âš¡ NLPå…­å±‚æŒ‡å¼•ï¼šå‡çº§ä½ çš„æ€ç»´æ¶æ„</h4>
                        <span class="text-indigo-400 text-2xl transition-transform duration-300" id="nlp-toggle">+</span>
                    </button>
                    <!-- NEW UX: collapsible-content for smooth animation -->
                    <div id="nlp-content" class="mt-4 collapsible-content text-gray-300 markdown-content">
                        <div class="space-y-6 pt-4">
                            <div id="nlp-environment" class="p-3 bg-gray-700/30 rounded-lg"><strong>ğŸŒ ç¯å¢ƒï¼š</strong></div>
                            <div id="nlp-behavior" class="p-3 bg-gray-700/30 rounded-lg"><strong>ğŸƒ è¡Œä¸ºï¼š</strong></div>
                            <div id="nlp-capacity" class="p-3 bg-gray-700/30 rounded-lg"><strong>ğŸ§  èƒ½åŠ›ï¼š</strong></div>
                            <div id="nlp-belief-value" class="p-3 bg-gray-700/30 rounded-lg"><strong>â¤ï¸ ä¿¡å¿µä¸ä»·å€¼è§‚ï¼š</strong></div>
                            <div id="nlp-identity" class="p-3 bg-gray-700/30 rounded-lg"><strong>ğŸ‘¤ èº«ä»½ï¼š</strong></div>
                            <div id="nlp-mission" class="p-3 bg-gray-700/30 rounded-lg"><strong>âœ¨ ç²¾ç¥/ä½¿å‘½ï¼š</strong></div>
                        </div>
                    </div>
                </div>

                <!-- 2. ç²¾åŠ›ç®¡ç†æŒ‡å¼• (å·²ä¼˜åŒ–ä¸ºå››ç»´+è¡¥ç»™å“åç§°) -->
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700" id="energy-card">
                    <button class="flex justify-between items-center w-full focus:outline-none" onclick="toggleSection('energy-content', 'energy-toggle')">
                        <h4 class="2xl font-bold text-yellow-400">ğŸ”‹ ç²¾åŠ›ç®¡ç†æŒ‡å¼•ï¼šå››ç»´å¹³è¡¡ä¸ä¸“å±è¡¥ç»™å“</h4>
                        <span class="text-yellow-400 text-2xl transition-transform duration-300" id="energy-toggle">+</span>
                    </button>
                    <!-- NEW UX: collapsible-content for smooth animation -->
                    <div id="energy-content" class="mt-4 collapsible-content text-gray-300 markdown-content">
                        <div class="space-y-6 pt-4">
                            <!-- NEW: å››ç»´ç²¾åŠ›ç°åœ¨åŒ…å«ä¸“å±è¡¥ç»™å“åç§° -->
                            <div id="energy-physical" class="p-3 bg-gray-700/30 rounded-lg"><strong>ğŸ’ª ä½“èƒ½ (<span class="text-accent" id="physical-supply">è¡¥ç»™å“</span>)ï¼š</strong></div>
                            <div id="energy-emotional" class="p-3 bg-gray-700/30 rounded-lg"><strong>ğŸ’– æƒ…ç»ª (<span class="text-accent" id="emotional-supply">è¡¥ç»™å“</span>)ï¼š</strong></div>
                            <div id="energy-mental" class="p-3 bg-gray-700/30 rounded-lg"><strong>ğŸ§  æ€ç»´ (<span class="text-accent" id="mental-supply">è¡¥ç»™å“</span>)ï¼š</strong></div>
                            <div id="energy-spiritual" class="p-3 bg-gray-700/30 rounded-lg"><strong>ğŸ”¥ æ„å¿— (<span class="text-accent" id="spiritual-supply">è¡¥ç»™å“</span>)ï¼š</strong></div>
                        </div>
                    </div>
                </div>

                <!-- 3. å“²å­¦ä¸‰é—® -->
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700" id="philosophy-card">
                    <button class="flex justify-between items-center w-full focus:outline-none" onclick="toggleSection('philosophy-content', 'philosophy-toggle')">
                        <h4 class="2xl font-bold text-pink-400">â“ å“²å­¦ä¸‰é—®ï¼šå¯»æ‰¾äººç”Ÿçš„ç»ˆæåæ ‡</h4>
                        <span class="text-pink-400 text-2xl transition-transform duration-300" id="philosophy-toggle">+</span>
                    </button>
                    <!-- NEW UX: collapsible-content for smooth animation -->
                    <div id="philosophy-content" class="mt-4 collapsible-content text-gray-300 markdown-content">
                        <div class="space-y-6 pt-4">
                            <div id="who-am-i" class="p-3 bg-gray-700/30 rounded-lg"><strong>æˆ‘æ˜¯è°ï¼Ÿ</strong></div>
                            <div id="where_from" class="p-3 bg-gray-700/30 rounded-lg"><strong>ä»å“ªé‡Œæ¥ï¼Ÿ</strong></div>
                            <div id="where_to" class="p-3 bg-gray-700/30 rounded-lg"><strong>è¦å»å“ªé‡Œï¼Ÿ</strong></div>
                        </div>
                    </div>
                </div>

                 <!-- 4. å¤©èµ‹æŒ‡å¼• (æ–°å¢ 'å¤©èµ‹é™·é˜±' ä¼˜åŒ–) -->
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700" id="talent-card">
                    <button class="flex justify-between items-center w-full focus:outline-none" onclick="toggleSection('talent-content', 'talent-toggle')">
                        <h4 class="2xl font-bold text-teal-400">ğŸ… å¤©èµ‹æŒ‡å¼•ï¼šä¼˜åŠ¿ä¸åŠ£åŠ¿è§£æ</h4>
                        <span class="text-teal-400 text-2xl transition-transform duration-300" id="talent-toggle">+</span>
                    </button>
                    <!-- NEW UX: collapsible-content for smooth animation -->
                    <div id="talent-content" class="mt-4 collapsible-content text-gray-300 markdown-content">
                        <div class="space-y-6 pt-4">
                            <div id="talent-strengths" class="p-3 bg-gray-700/30 rounded-lg"><strong>âœ… æ ¸å¿ƒä¼˜åŠ¿ï¼š</strong></div>
                            <!-- NEW: ä¼˜åŠ¿è¿‡åº¦ä½¿ç”¨é™·é˜± -->
                            <div id="talent-shadow" class="p-3 bg-red-900/40 rounded-lg border-l-4 border-red-500"><strong>âš ï¸ å¤©èµ‹é™·é˜± (é˜´å½±é¢)ï¼š</strong></div>
                            <div id="talent-weaknesses" class="p-3 bg-gray-700/30 rounded-lg"><strong>âŒ æ½œåœ¨åŠ£åŠ¿ï¼š</strong></div>
                        </div>
                    </div>
                </div>

                <!-- 5. æ€ç»´æ¨¡å‹ä¸æŠ€èƒ½ (æ–°å¢ 'åº”ç”¨åœºæ™¯' ä¼˜åŒ–) -->
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700" id="model-card">
                    <button class="flex justify-between items-center w-full focus:outline-none" onclick="toggleSection('model-content', 'model-toggle')">
                        <h4 class="2xl font-bold text-orange-400">ğŸ’¡ ä¸“å±æ€ç»´æ¨¡å‹ä¸æŠ€èƒ½</h4>
                        <span class="text-orange-400 text-2xl transition-transform duration-300" id="model-toggle">+</span>
                    </button>
                    <!-- NEW UX: collapsible-content for smooth animation -->
                    <div id="model-content" class="mt-4 collapsible-content text-gray-300 markdown-content">
                        <div class="space-y-6 pt-4">
                            <div id="mind-model-display" class="p-3 bg-gray-700/30 rounded-lg mb-4"></div>
                            <!-- NEW: æ€ç»´æ¨¡å‹çš„åº”ç”¨åœºæ™¯ -->
                            <div id="model-application-display" class="p-3 bg-gray-700/30 rounded-lg"><strong>ğŸ“– å®æ“åº”ç”¨åœºæ™¯ï¼š</strong></div>
                        </div>
                    </div>
                </div>

                <!-- 6. å·¥å…·æŒ‡å¼• (ä¿æŒ) -->
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700" id="tool-card">
                    <button class="flex justify-between items-center w-full focus:outline-none" onclick="toggleSection('tool-content', 'tool-toggle')">
                        <h4 class="2xl font-bold text-cyan-400">ğŸ› ï¸ ä¸“å±å·¥å…·æŒ‡å¼•</h4>
                        <span class="text-cyan-400 text-2xl transition-transform duration-300" id="tool-toggle">+</span>
                    </button>
                    <!-- NEW UX: collapsible-content for smooth animation -->
                    <div id="tool-content" class="mt-4 collapsible-content text-gray-300 markdown-content">
                        <div class="space-y-6 pt-4">
                            <div id="tool-guidance-display" class="p-3 bg-gray-700/30 rounded-lg"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è§’è‰²è¡ŒåŠ¨è§„åˆ’ (æ–°å¢ 'å¯é‡åŒ–æŒ‡æ ‡' ä¼˜åŒ–) -->
            <div id="action-plan-container" class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-accent/50 mb-8">
                <button id="generate-plan-btn" class="w-full bg-accent hover:bg-emerald-600 text-gray-900 font-bold py-3 rounded-xl shadow-md transition duration-300 ease-in-out flex items-center justify-center">
                    <span class="mr-2 text-2xl">âœ¨</span> è§’è‰²è¡ŒåŠ¨è§„åˆ’ï¼šå°†æ´å¯Ÿè½¬åŒ–ä¸ºè¡ŒåŠ¨ï¼
                </button>
                <div id="action-plan-result" class="mt-4 hidden p-4 bg-gray-700/50 rounded-lg border border-gray-600">
                    <h5 class="xl font-bold text-accent mb-3 border-b border-gray-600 pb-2" id="plan-title-display"></h5>
                    <ul id="plan-list" class="list-none space-y-3 text-gray-300">
                        <!-- Plan steps will be inserted here -->
                    </ul>
                </div>
                <p id="plan-loading-message" class="text-center text-gray-400 mt-4 hidden">æ­£åœ¨ä¸ºä½ åˆ¶å®šä¸‹ä¸€æ­¥çš„è¡ŒåŠ¨è·¯çº¿...</p>
            </div>
            
            <button onclick="showContainer(inputFormContainer); hideContainer(resultCard);" class="mt-10 w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl transition duration-300 ease-in-out">
                é‡æ–°ç”Ÿæˆæ–°çš„è§’è‰²æ‰‹å†Œ
            </button>
        </div>
        
        <!-- NEW: å³æ—¶æ‰§è¡Œè„šæœ¬ - ç¡®ä¿ç»“æœå¡ç‰‡åœ¨æµè§ˆå™¨è§£ææ—¶ç«‹å³éšè— -->
        <script>
            // è¿™ä¸ªè„šæœ¬ä¼šåœ¨è§£æåˆ° #result-card ä¹‹åç«‹å³æ‰§è¡Œ
            const rc_immediate_fix = document.getElementById('result-card');
            if (rc_immediate_fix) {
                rc_immediate_fix.style.display = 'none';
                rc_immediate_fix.style.opacity = '0';
                rc_immediate_fix.style.pointerEvents = 'none';
            }
        </script>

    </div>

    <script>
        // å…¨å±€å˜é‡å’Œé…ç½®
        let API_KEY = (localStorage.getItem('gemini_api_key') || "gen-lang-client-0412306217").trim(); // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„æµè§ˆå™¨å¯†é’¥

        // NEW: é›†ä¸­é…ç½®å¸¸é‡
        const CONFIG = {
            apiKey: API_KEY,
            endpoints: {
                // ä½¿ç”¨ Header ä¼ é€’ API Keyï¼Œé¿å… URL å‚æ•°å¯¼è‡´çš„æ‹¦æˆª/é¢„æ£€å¼‚å¸¸
                text: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent`,
                image: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent`
            },
            request: {
                // è°ƒè¯•æœŸç¦ç”¨è¶…æ—¶ï¼Œé¿å…æµè§ˆå™¨ä¸»åŠ¨ä¸­æ–­è¯·æ±‚
                textTimeoutMs: 0,
                imageTimeoutMs: 0,
                retry: {
                    maxRetries: 5,
                    baseDelayMs: 1000,
                    jitterMs: 1000,
                    statusBackoff: { '429': 5000 }
                }
            },
            upload: {
                maxBytes: 3 * 1024 * 1024,
                allowedMimeTypes: ['image/png', 'image/jpeg', 'image/webp']
            }
        };

        // API Key æ ¡éªŒï¼ˆä»…æµè§ˆå™¨å¯†é’¥ï¼Œéœ€ä»¥ gen-lang-client- å¼€å¤´ï¼‰
        function validateApiKey(key) {
            if (!key || !key.trim()) return { ok: false, reason: 'æœªé…ç½® API Key' };
            const trimmed = key.trim();
            if (!trimmed.startsWith('gen-lang-client-')) {
                return { ok: false, reason: 'API Key æ ¼å¼ä¸æ­£ç¡®ï¼ˆéœ€ä»¥ gen-lang-client- å¼€å¤´çš„æµè§ˆå™¨å¯†é’¥ï¼‰' };
            }
            return { ok: true };
        }

        // å…¼å®¹æ—§ç”¨æ³•çš„å¸¸é‡ï¼ˆä¿æŒç°æœ‰è°ƒç”¨ä¸å´©ï¼‰
        const GEMINI_API_URL = CONFIG.endpoints.text;
        const GEMINI_IMAGE_API_URL = CONFIG.endpoints.image;
        
        // XSS æ¸…æ´—å‡½æ•°
        function sanitizeHTML(html) {
            const temp = document.createElement('div');
            temp.textContent = html;
            return temp.innerHTML;
        }
        
        // DOM å…ƒç´ 
        const form = document.getElementById('character-form');
        const photoInput = document.getElementById('photo');
        const submitBtn = document.getElementById('submit-btn');
        const loadingArea = document.getElementById('loading-area');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const resultCard = document.getElementById('result-card');
        const inputFormContainer = document.getElementById('input-form-container');
        const progressBar = document.getElementById('progress-bar');
        
        // è¡¨å•æ ¡éªŒå‡½æ•°
        function validateForm() {
            let isValid = true;
            
            // å§“åæ ¡éªŒ
            const nameInput = document.getElementById('name');
            const nameError = document.getElementById('name-error');
            
            if (!nameInput.value.trim()) {
                nameError.textContent = "è¯·è¾“å…¥å§“åæˆ–è§’è‰²ä»£å·";
                nameError.classList.remove('hidden');
                isValid = false;
            } else if (nameInput.value.length > 30) {
                nameError.textContent = "å§“åé•¿åº¦ä¸èƒ½è¶…è¿‡30ä¸ªå­—ç¬¦";
                nameError.classList.remove('hidden');
                isValid = false;
            } else {
                nameError.classList.add('hidden');
            }
            
            // ä¸ªäººä»‹ç»æ ¡éªŒ
            const introInput = document.getElementById('intro');
            const introError = document.getElementById('intro-error');
            
            if (introInput && !introInput.value.trim()) {
                introError.textContent = "è¯·è¾“å…¥ä¸ªäººä»‹ç»æˆ–å½“å‰å›°å¢ƒ";
                introError.classList.remove('hidden');
                isValid = false;
            } else if (introInput && introInput.value.length > 500) {
                introError.textContent = "ä»‹ç»é•¿åº¦ä¸èƒ½è¶…è¿‡500ä¸ªå­—ç¬¦";
                introError.classList.remove('hidden');
                isValid = false;
            } else if (introInput) {
                introError.classList.add('hidden');
            }
            
            return isValid;
        }

        // NEW: ç»Ÿä¸€é”™è¯¯æç¤º
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }
        
        // è‡ªè¯„é‡è¡¨ DOM
        const selfPhysical = document.getElementById('self-physical');
        const selfEmotional = document.getElementById('self-emotional');
        const selfMental = document.getElementById('self-mental');
        const selfSpiritual = document.getElementById('self-spiritual');
        
        // ä¸»é¢˜ç›¸å…³ DOM
        const body = document.body;
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        
        // è½®æ’­å›¾çŠ¶æ€ (FIXED: 2å¼ å›¾)
        let currentSlide = 0;
        const totalSlides = 2;
        const TOTAL_PROCESS_STEPS = 4; // 1. Read/Setup, 2. Gen Text, 3. Gen Image 1, 4. Gen Image 2
        let currentProcessStep = 0;


        // NEW: ç»‘å®šé‡è¡¨å€¼æ˜¾ç¤º
        selfPhysical.addEventListener('input', () => document.getElementById('self-physical-value').textContent = selfPhysical.value);
        selfEmotional.addEventListener('input', () => document.getElementById('self-emotional-value').textContent = selfEmotional.value);
        selfMental.addEventListener('input', () => document.getElementById('self-mental-value').textContent = selfMental.value);
        selfSpiritual.addEventListener('input', () => document.getElementById('self-spiritual-value').textContent = selfSpiritual.value);
        
        
        // --- è¿›åº¦æ¡æ›´æ–°å‡½æ•° (NEW FEATURE) ---
        function updateProgress(stepMessage) {
            currentProcessStep++;
            const percent = Math.min(100, Math.round((currentProcessStep / TOTAL_PROCESS_STEPS) * 100));
            progressBar.style.width = `${percent}%`;
            loadingMessage.textContent = stepMessage;
        }

        // --- å¼ºåˆ¶é¡µé¢åˆ‡æ¢å‡½æ•° (FIXED: ä½¿ç”¨ Class-Based åˆ‡æ¢) ---
        function showContainer(element) {
            // ç¡®ä¿åªæœ‰ä¸€ä¸ªä¸»å®¹å™¨æ˜¯æ´»è·ƒçš„
            if (element === inputFormContainer) {
                hideContainer(resultCard);
            } else if (element === resultCard) {
                hideContainer(inputFormContainer);
            }
            // å¼ºåˆ¶æ˜¾ç¤º (ç§»é™¤ inactive ç±»)
            element.classList.remove('page-inactive');
            element.style.opacity = '1';
            element.style.pointerEvents = 'auto';
        }

        function hideContainer(element) {
            // å¼ºåˆ¶éšè— (æ·»åŠ  inactive ç±»)
            element.classList.add('page-inactive');
            element.style.opacity = '0';
            element.style.pointerEvents = 'none';
        }
        
        // --- æŠ˜å é¢æ¿åˆ‡æ¢å‡½æ•° (NEW UX: å¢åŠ åŠ¨ç”») ---
        function toggleSection(contentId, toggleId) {
            const content = document.getElementById(contentId);
            const toggleIcon = document.getElementById(toggleId);
            
            if (content.classList.contains('active')) {
                // æŠ˜å 
                content.classList.remove('active');
                toggleIcon.classList.remove('rotate-90');
                content.style.maxHeight = '0'; // å¯ç”¨CSSè¿‡æ¸¡
            } else {
                // å±•å¼€
                content.classList.add('active');
                toggleIcon.classList.add('rotate-90');
                // ç«‹å³è®¾ç½®ä¸€ä¸ªå¤§é«˜åº¦æ¥å¼€å§‹è¿‡æ¸¡
                content.style.maxHeight = content.scrollHeight + 'px'; 
            }
        }
        
        // --- ä¸»é¢˜åˆ‡æ¢é€»è¾‘ (é‡æ„ä¸ºä½¿ç”¨ Tailwind dark: å˜ä½“) ---
        function toggleTheme() {
            const isDark = body.classList.contains('dark');
            
            if (isDark) {
                body.classList.remove('dark');
                // åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼å›¾æ ‡
                themeToggleBtn.innerHTML = '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 01-2 0V3a1 1 0 011-1zm6.95 6.95a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM3.732 3.732a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zm13.136 12.728a1 1 0 01-1.414 0l-.707-.707a1 1 0 011.414-1.414l.707.707a1 1 0 010 1.414zM4 10a1 1 0 011-1h1a1 1 0 010 2H5a1 1 0 01-1-1zm12-1h1a1 1 0 010 2h-1a1 1 0 010-2zm-6 6a4 4 0 100-8 4 4 0 000 8zm0 2a6 6 0 110-12 6 6 0 010 12z"></path></svg>';
            } else {
                body.classList.add('dark');
                // åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼å›¾æ ‡
                themeToggleBtn.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>';
            }
            
            // å¼ºåˆ¶é¢œè‰²å¯¹æ¯”åº¦ä¿®å¤ (åœ¨åˆ‡æ¢ä¸»é¢˜æ—¶è¿è¡Œ)
            const roleDesc = document.getElementById('role-description-display');
            const goldenSent = document.getElementById('golden-sentence-display');

            const newTheme = body.classList.contains('dark') ? 'dark' : 'light';
            
            if (newTheme === 'light') {
                // æµ…è‰²æ¨¡å¼ï¼šæ·±è‰²æ–‡æœ¬
                if (roleDesc) roleDesc.classList.replace('text-gray-200', 'text-gray-900');
                if (goldenSent) goldenSent.classList.replace('text-gray-100', 'text-gray-800');
            } else {
                // æ·±è‰²æ¨¡å¼ï¼šæµ…è‰²æ–‡æœ¬
                if (roleDesc) roleDesc.classList.replace('text-gray-900', 'text-gray-200');
                if (goldenSent) goldenSent.classList.replace('text-gray-800', 'text-gray-100');
            }
        }
        // --- è½®æ’­å›¾æ§åˆ¶é€»è¾‘ ---
        function updateCarousel() {
            const track = document.getElementById('carousel-track');
            if (track) {
                const offset = -currentSlide * 100;
                track.style.transform = `translateX(${offset}%)`;
            }
        }

        function moveSlide(direction) {
            currentSlide += direction;
            if (currentSlide >= totalSlides) {
                currentSlide = 0;
            } else if (currentSlide < 0) {
                currentSlide = totalSlides - 1;
            }
            updateCarousel();
        }

        // --- è¾…åŠ©å‡½æ•° ---

        async function fetchWithBackoff(url, options, maxRetries = CONFIG.request.retry.maxRetries) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    // è¶…æ—¶æ§åˆ¶
                    const timeoutMs = url.includes(CONFIG.endpoints.image)
                        ? CONFIG.request.imageTimeoutMs
                        : CONFIG.request.textTimeoutMs;
                    const controller = timeoutMs > 0 ? new AbortController() : null;
                    const timeoutId = controller ? setTimeout(() => controller.abort(), timeoutMs) : null;
                    const response = await fetch(url, { ...options, signal: controller ? controller.signal : undefined });
                    if (timeoutId) clearTimeout(timeoutId);
                    let responseText = await response.text(); 
                    
                    if (!response.ok) {
                        let errorData = {};
                        let errorMessage = response.statusText;
                        
                        try {
                            errorData = JSON.parse(responseText);
                            errorMessage = errorData.error ? errorData.error.message : response.statusText;
                        } catch (e) {
                            // ä¿®æ­£ï¼šå¦‚æœå“åº”çŠ¶æ€æ˜¯ 401 ä¸”ä¸æ˜¯ JSONï¼Œç›´æ¥è¿”å›æˆæƒé”™è¯¯æç¤º
                            if (response.status === 401) {
                                throw new Error("æˆæƒå¤±è´¥ (401)ã€‚è¯·ç¡®ä¿æ‚¨çš„ Gemini API Key å·²æ­£ç¡®é…ç½®æˆ–æˆæƒã€‚");
                            }
                            // Non-JSON error body (usually occurs with 401 if API key is missing)
                            throw new Error(`API error: ${response.status} - Non-JSON error body. Text: ${responseText.substring(0, 100)}`);
                        }
                        
                        throw new Error(`API error: ${response.status} ${errorMessage}`);
                    }
                    
                    // Successful path (response.ok)
                    if (!responseText) {
                        // å›¾åƒ API è¿”å›ç©ºå†…å®¹æ—¶ï¼Œè¿™é‡Œä¼šæ•è·ã€‚
                         if (url.includes(CONFIG.endpoints.image)) {
                            // å›¾åƒ API æœ‰æ—¶æˆåŠŸä½†è¿”å›ç©ºå†…å®¹ï¼Œå¯èƒ½æ˜¯æ¨¡å‹å†…éƒ¨é”™è¯¯ã€‚
                            throw new Error("å›¾åƒ API è¿”å›äº†æˆåŠŸçš„çŠ¶æ€ç ï¼Œä½†å†…å®¹ä¸ºç©ºã€‚");
                        }
                        throw new SyntaxError("Unexpected end of input: Empty response body on successful API call.");
                    }
                    return JSON.parse(responseText); 
                    
                } catch (error) {
                    // è¶…æ—¶ç‰¹æ®Šæç¤º
                    if (error.name === 'AbortError') {
                        if (i === maxRetries - 1) throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•ã€‚');
                    }
                    // æµè§ˆå™¨æˆ–ç½‘ç»œå±‚ä¸­æ–­ï¼ˆå¦‚æ’ä»¶æ‹¦æˆªã€CORS é¢„æ£€å¤±è´¥ã€ç½‘ç»œé˜»æ–­ï¼‰
                    const msg = String(error && (error.message || error.toString())).toUpperCase();
                    if (msg.includes('ERR_ABORTED') || msg.includes('FAILED TO FETCH')) {
                        if (i === maxRetries - 1) {
                            throw new Error('ç½‘ç»œè¯·æ±‚è¢«ä¸­æ–­æˆ–æ‹¦æˆªã€‚è¯·æ£€æŸ¥ï¼š1) å…³é—­å¹¿å‘Š/å®‰å…¨æ‹¦æˆªæ’ä»¶ï¼›2) ç¡®è®¤ AI Studio çš„æµè§ˆå™¨å¯†é’¥å…è®¸ http://localhostï¼›3) ç½‘ç»œä»£ç†æˆ–é˜²ç«å¢™è®¾ç½®ï¼›å¿…è¦æ—¶ä½¿ç”¨æœåŠ¡ç«¯ä»£ç†ã€‚');
                        }
                    }
                    if (i === maxRetries - 1) throw error;
                    // è§£æ 429 ç­‰çŠ¶æ€è¿›è¡Œæ›´é•¿é€€é¿
                    let delay = Math.pow(2, i) * CONFIG.request.retry.baseDelayMs + Math.random() * CONFIG.request.retry.jitterMs;
                    const match = /API error: (\d+)/.exec(error.message || '');
                    if (match && CONFIG.request.retry.statusBackoff[match[1]]) {
                        delay = CONFIG.request.retry.statusBackoff[match[1]] + Math.random() * CONFIG.request.retry.jitterMs;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        /**
         * å°†æ–‡ä»¶è½¬æ¢ä¸º Base64 å­—ç¬¦ä¸²
         */
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    return resolve(null);
                }
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]); // Only need the Base64 part
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /**
         * æ­¥éª¤ 1: ç”Ÿæˆä¸¤å¼  AI è§’è‰²å½¢è±¡ (Gemini 2.5 Flash Image) (FIXED: 2 images)
         */
        async function generateTwoImages(fantasyRoleName, realisticRoleName, base64Image, base64ImageMimeType) {
            
            // å®šä¹‰ä¸¤ä¸ªä¸åŒä¸»é¢˜çš„å›¾åƒç”Ÿæˆæç¤º
            const imagePrompts = [
                { id: 0, theme: "å¹»æƒ³è§’è‰² (Fantasy Role)", role: fantasyRoleName, 
                  prompt: `åŸºäºç”¨æˆ·æä¾›çš„ç…§ç‰‡ä½œä¸ºä¸»è§’å’Œé£æ ¼å‚è€ƒï¼Œç»“åˆå…¶å¹»æƒ³è§’è‰²åç§°'${fantasyRoleName}'çš„æ ¸å¿ƒç‰¹è´¨ï¼Œä»¥å²è¯—ã€å¥‡å¹»è‰ºæœ¯æ•ˆæœç”Ÿæˆä¸€å¼ è‚–åƒå›¾ã€‚è¦æ±‚è‚–åƒå›¾é£æ ¼ä¿æŒä¸€è‡´æ€§ï¼Œä¸”ä¸»è§’å½¢è±¡éœ€æ¸…æ™°ã€æ­£é¢ï¼Œä½“ç°å¹»æƒ³æ„Ÿã€‚` },
                { id: 1, theme: "ç°å®èº«ä»½ (Realistic Persona)", role: realisticRoleName, 
                  prompt: `åŸºäºç”¨æˆ·æä¾›çš„ç…§ç‰‡ä½œä¸ºä¸»è§’å’Œé£æ ¼å‚è€ƒï¼Œç»“åˆå…¶ç°å®èº«ä»½åç§°'${realisticRoleName}'çš„èŒä¸šç‰¹å¾ï¼Œä»¥ç°ä»£ã€ä¸“ä¸šè‚–åƒè‰ºæœ¯æ•ˆæœç”Ÿæˆä¸€å¼ è‚–åƒå›¾ã€‚è¦æ±‚è‚–åƒå›¾é£æ ¼ä¿æŒä¸€è‡´æ€§ï¼Œä¸”ä¸»è§’å½¢è±¡éœ€æ¸…æ™°ã€æ­£é¢ï¼Œä½“ç°ä¸“ä¸šæ„Ÿã€‚` }
            ];

            const imageResults = [];
            
            for (let i = 0; i < imagePrompts.length; i++) {
                const { theme, prompt } = imagePrompts[i];
                
                const parts = [];
                parts.push({ text: prompt }); // æ€»æ˜¯æ·»åŠ æ–‡æœ¬æç¤º

                // åªæœ‰åœ¨ä¸Šä¼ äº†å›¾ç‰‡æ—¶æ‰æ·»åŠ  inlineData
                if (base64Image) {
                    parts.push({
                        inlineData: {
                            mimeType: base64ImageMimeType, 
                            data: base64Image
                        }
                    });
                }
                
                const payload = {
                    contents: [{ role: "user", parts: parts }],
                    generationConfig: {
                        responseModalities: ['IMAGE'],
                        sampleCount: 1 // æ¯æ¬¡åªè¯·æ±‚ä¸€å¼ 
                    },
                };

                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };

                // CRITICAL FIX: Add local try/catch to ensure the loop completes and pushes 2 items.
                try {
                    // Update progress for Image 1 (Step 3) and Image 2 (Step 4)
                    updateProgress(i === 0 ? `3/4: ç»˜åˆ¶å¹»æƒ³è§’è‰²å½¢è±¡...` : `4/4: ç»˜åˆ¶ç°å®èº«ä»½å½¢è±¡...`);
                    
                    const response = await fetchWithBackoff(GEMINI_IMAGE_API_URL, options);
                    
                    const base64Data = response.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    
                    if (base64Data) {
                        imageResults.push(`data:image/png;base64,${base64Data}`);
                    } else {
                        console.error(`ERROR: å›¾åƒç”Ÿæˆå¤±è´¥ (${theme}). API returned empty content.`); // Stronger logging
                        // å¦‚æœ API æˆåŠŸä½†è¿”å›ç©ºå†…å®¹ï¼Œæ¨ä¸€ä¸ªé”™è¯¯å ä½ç¬¦
                        imageResults.push(`https://placehold.co/400x400/dc2626/ffffff?text=å›¾åƒç”Ÿæˆå¤±è´¥+${i+1}`); 
                    }
                } catch (error) {
                    console.error(`ERROR: å›¾åƒç”Ÿæˆè¯·æ±‚å¤±è´¥ (${theme}). Error:`, error);
                    // ä»»ä½• API é”™è¯¯ï¼ˆåŒ…æ‹¬ 401, 500, è¶…æ—¶ï¼‰éƒ½æ¨ä¸€ä¸ªé”™è¯¯å ä½ç¬¦
                    imageResults.push(`https://placehold.co/400x400/dc2626/ffffff?text=å›¾åƒç”Ÿæˆå¤±è´¥+${i+1}`); 
                }
            }
            console.log(`Image Generation Results Count: ${imageResults.length}`); // Log count
            return imageResults;
        }


        /**
         * æ­¥éª¤ 2: ç”Ÿæˆ AI è§’è‰²æ‰‹å†Œæ–‡æœ¬ (Gemini 2.5 Flash)
         */
        async function generateText(data) {
            const { name, mbti, zodiac, animal, bazi, strengths, intro, 'life-stage': lifeStage, 'lunar-birthday': lunarBirthday, 'self-physical': selfPhysical, 'self-emotional': selfEmotional, 'self-mental': selfMental, 'self-spiritual': selfSpiritual } = data;

            const systemPrompt = "ä½ æ˜¯ä¸€ä½ä¸–ç•Œçº§çš„ä¸ªäººæˆé•¿å¯¼å¸ˆå’Œäººå·¥æ™ºèƒ½å¿ƒç†å­¦å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„å¤šç»´åº¦ä¿¡æ¯ï¼Œä¸ºä»–ä»¬é‡èº«æ‰“é€ ä¸€ä¸ªç‹¬ç‰¹çš„'åœ°çƒOLè§’è‰²æ‰‹å†Œ'ï¼Œå†…å®¹éœ€åŒ…å«'å¹»æƒ³è§’è‰²'å’Œ'ç°å®èº«ä»½'ä¸¤ç§ç±»å‹å¹¶ç»™å‡ºç™¾åˆ†æ¯”é€‚é…åº¦ã€‚æ‰‹å†Œå†…å®¹å¿…é¡»åŒ…æ‹¬ï¼šåŒè§’è‰²æè¿°ã€NLPå…­å±‚æŒ‡å¼•ã€ç²¾åŠ›ç®¡ç†æŒ‡å¼•ï¼ˆåˆ†ä½“èƒ½ã€æƒ…ç»ªã€æ€ç»´ã€æ„å¿—å››ç»´ï¼‰ã€å“²å­¦ä¸‰é—®ã€å¤©èµ‹æŒ‡å¼•ï¼ˆä¼˜åŠ¿å’ŒåŠ£åŠ¿ï¼‰ã€ä¸“å±æ€ç»´æ¨¡å‹å’Œå·¥å…·æŒ‡å¼•ã€‚æ‰€æœ‰è¾“å‡ºå¿…é¡»ä¸¥æ ¼éµå®ˆæä¾›çš„JSON Schemaæ ¼å¼ã€‚åœ¨ç”Ÿæˆå†…å®¹æ—¶ï¼Œè¯·åŠ¡å¿…ä½¿ç”¨ä¸­æ–‡ï¼Œå¹¶èå…¥å¹½é»˜ã€åäººæ¡ˆä¾‹å’Œé¼“èˆäººå¿ƒçš„é‡‘å¥ã€‚**æ³¨æ„ï¼šæ‰€æœ‰çš„æŒ‡å¼•å†…å®¹ï¼ˆé™¤äº†è§’è‰²åç§°/ç‰¹è´¨/é‡‘å¥ï¼‰éƒ½åº”ä½¿ç”¨ Markdown æ ¼å¼ï¼ˆå¦‚æ¢è¡Œã€åˆ—è¡¨æˆ–ç²—ä½“ï¼‰æ¥ç¡®ä¿æ ¼å¼æ¸…æ™°ï¼Œè§£å†³å†…å®¹æ‹¥æŒ¤é—®é¢˜ã€‚**";
            
            const userQuery = `è¯·æ ¹æ®ä»¥ä¸‹ç”¨æˆ·æ•°æ®ç”Ÿæˆè§’è‰²æ‰‹å†Œï¼š
- å§“å/ä»£å·: ${name}
- MBTI: ${mbti}
- æ˜Ÿåº§: ${zodiac}
- ç”Ÿè‚–: ${animal}
- å…«å­—/äººç±»å›¾ï¼ˆå…³é”®å­—ï¼‰: ${bazi || 'æœªæä¾›'}
- ç›–æ´›æ™®ä¼˜åŠ¿/æ ¸å¿ƒæŠ€èƒ½: ${strengths || 'æœªæä¾›'}
- å½“å‰äººç”Ÿé˜¶æ®µ: ${lifeStage}
- å†œå†ç”Ÿæ—¥ä¿¡æ¯: ${lunarBirthday || 'æœªæä¾›'}
- **ç”¨æˆ·å½“å‰ç²¾åŠ›è‡ªè¯„**: (ä½“èƒ½: ${selfPhysical}/5, æƒ…ç»ª: ${selfEmotional}/5, æ€ç»´: ${selfMental}/5, æ„å¿—: ${selfSpiritual}/5)
- ä¸ªäººä»‹ç»/å½“å‰å›°å¢ƒ: ${intro}`;

            const jsonSchema = {
                type: "OBJECT",
                properties: {
                    // NEW: åŒè§’è‰²ç»“æ„
                    "character_profiles": {
                        "type": "OBJECT",
                        "description": "å¹»æƒ³è§’è‰²å’Œç°å®èº«ä»½çš„å¯¹æ¯”åˆ†æã€‚",
                        "properties": {
                            "fantasy_role": {
                                "type": "OBJECT",
                                "properties": {
                                    "name": { "type": "STRING", "description": "æ¸¸æˆåŒ–/å¹»æƒ³åŒ–çš„è§’è‰²åç§°ï¼Œä¾‹å¦‚ï¼š'è¿½å…‰è€…', 'æˆ˜ç•¥å»ºç­‘å¸ˆ'ã€‚" },
                                    "trait": { "type": "STRING", "description": "æ ¸å¿ƒç‰¹è´¨ï¼Œç”¨ä¸€å¥è¯æ¦‚æ‹¬è§’è‰²çš„ç²¾é«“ã€‚" },
                                    "fit_percentage": { "type": "INTEGER", "description": "é€‚é…åº¦ç™¾åˆ†æ¯” (0-100)ã€‚" }
                                },
                                "required": ["name", "trait", "fit_percentage"]
                            },
                            "realistic_persona": {
                                "type": "OBJECT",
                                "properties": {
                                    "name": { "type": "STRING", "description": "ç°å®èŒä¸š/èº«ä»½åç§°ï¼Œä¾‹å¦‚ï¼š'é«˜æƒ…å•†é¡¹ç›®ç»ç†', 'æ•°æ®é©±åŠ¨çš„è‡ªç”±ä½œå®¶'ã€‚" },
                                    "fit_percentage": { "type": "INTEGER", "description": "é€‚é…åº¦ç™¾åˆ†æ¯” (0-100)ã€‚" }
                                },
                                "required": ["name", "fit_percentage"]
                            }, // FIX: Correctly close realistic_persona and add comma before next property
                            // The redundant "fit_percentage" property was removed in the previous fix.
                        },
                        "required": ["fantasy_role", "realistic_persona"]
                    },
                    "role_description": { "type": "STRING", "description": "è¯¦ç»†çš„è§’è‰²æè¿°ï¼Œç»“åˆæ‰€æœ‰è¾“å…¥ä¿¡æ¯ï¼Œç”¨ç”ŸåŠ¨çš„è¯­è¨€æç»˜è§’è‰²çš„æ€§æ ¼ã€å¤©èµ‹å’Œæ½œåœ¨æŒ‘æˆ˜ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚æ­¤æè¿°åº”ä»¥å¹»æƒ³è§’è‰²ä¸ºä¸»ä½“ã€‚" },
                    
                    // NEW: å¤©èµ‹æŒ‡å¼• (åŒ…å«ä¼˜åŠ¿é™·é˜±)
                    "talent_guidance": {
                        "type": "OBJECT",
                        "description": "åŸºäºMBTIã€ä¼˜åŠ¿ç­‰å¾—å‡ºçš„ä¼˜åŠ¿å’ŒåŠ£åŠ¿åˆ†æã€‚",
                        "properties": {
                            "strengths": { "type": "STRING", "description": "æ ¸å¿ƒä¼˜åŠ¿å’Œå¤©èµ‹ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" },
                            "shadow_trait": { "type": "STRING", "description": "ä¼˜åŠ¿è¿‡åº¦ä½¿ç”¨åçš„é˜´å½±é¢æˆ–é™·é˜±ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" },
                            "weaknesses": { "type": "STRING", "description": "æ½œåœ¨çš„ç›²ç‚¹å’ŒåŠ£åŠ¿ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" }
                        },
                        "required": ["strengths", "shadow_trait", "weaknesses"]
                    },
                    // NEW: ä¸“å±æ€ç»´æ¨¡å‹ (åŒ…å«åº”ç”¨åœºæ™¯)
                    "mind_model": { "type": "STRING", "description": "ä¸“å±æ€ç»´æ¨¡å‹å’ŒæŠ€èƒ½ï¼Œä¾‹å¦‚ï¼š'ç¬¬ä¸€æ€§åŸç†æ€è€ƒæ³•'ï¼Œ'æ—¶é—´ç®±æŠ€æœ¯'ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" },
                    "model_application": { "type": "STRING", "description": "æ¨èæ€ç»´æ¨¡å‹åœ¨ç”¨æˆ·å½“å‰å›°å¢ƒä¸­çš„å…·ä½“åº”ç”¨åœºæ™¯å’Œæ­¥éª¤ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" },
                    // NEW: å·¥å…·æŒ‡å¼•
                    "tool_guidance": { "type": "STRING", "description": "æ¨èçš„å®ç”¨å·¥å…·/æ–¹æ³•è®ºï¼Œä¾‹å¦‚ï¼šæ¨èä½¿ç”¨é¡¹ç›®ç®¡ç†å·¥å…·Trelloã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" },
                    
                    "nlp_guidance": {
                        "type": "OBJECT",
                        "properties": {
                            "environment": { "type": "STRING", "description": "ç¯å¢ƒå±‚é¢çš„æŒ‡å¯¼ï¼Œä¾‹å¦‚ï¼šä½ é€‚åˆåœ¨ä»€ä¹ˆæ ·çš„å›¢é˜Ÿä¸­æˆé•¿ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" },
                            "behavior": { "type": "STRING", "description": "è¡Œä¸ºå±‚é¢çš„æŒ‡å¯¼ï¼Œæä¾›å…·ä½“çš„è¡ŒåŠ¨å»ºè®®ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" },
                            "capacity": { "type": "STRING", "description": "èƒ½åŠ›å±‚é¢çš„æŒ‡å¯¼ï¼Œå¦‚ä½•å‘æŒ¥å’Œæå‡ä½ çš„æ ¸å¿ƒæŠ€èƒ½ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" },
                            "belief_value": { "type": "STRING", "description": "ä¿¡å¿µä¸ä»·å€¼è§‚å±‚é¢çš„æŒ‡å¯¼ï¼Œä¾‹å¦‚ï¼šä½ éœ€è¦ç›¸ä¿¡ä»€ä¹ˆæ‰èƒ½æˆåŠŸã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" },
                            "identity": { "type": "STRING", "description": "èº«ä»½å±‚é¢çš„æŒ‡å¯¼ï¼Œå¸®åŠ©ç”¨æˆ·å®šä¹‰è‡ªå·±æ˜¯è°ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" },
                            "mission": { "type": "STRING", "description": "ç²¾ç¥/ä½¿å‘½å±‚é¢çš„æŒ‡å¯¼ï¼Œæ¢ç´¢äººç”Ÿçš„æ›´é«˜æ„ä¹‰ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" }
                        },
                        "propertyOrdering": ["environment", "behavior", "capacity", "belief_value", "identity", "mission"]
                    },
                    "energy_management": { 
                        "type": "OBJECT",
                        "description": "è¯¦ç»†çš„ç²¾åŠ›ç®¡ç†æŒ‡å¼•ï¼Œåˆ†ä¸ºä½“èƒ½ã€æƒ…ç»ªã€æ€ç»´ã€æ„å¿—å››ä¸ªæ–¹é¢ã€‚",
                        "properties": {
                            // NEW: æ¯ä¸ªç»´åº¦åŒ…å«ä¸“å±è¡¥ç»™å“åç§° (supply_name)
                            "physical": { "type": "STRING", "description": "ä½“èƒ½ç®¡ç†æŒ‡å¼•ï¼Œå…³äºä¼‘æ¯ã€è¥å…»å’Œè¿åŠ¨ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" },
                            "physical_supply_name": { "type": "STRING", "description": "ä½“èƒ½ä¸“å±è¡¥ç»™å“åç§°ï¼Œä¾‹å¦‚ï¼š'çŒäººåˆåæ¼«æ­¥'" },
                            "emotional": { "type": "STRING", "description": "æƒ…ç»ªç®¡ç†æŒ‡å¼•ï¼Œå…³äºç§¯ææƒ…æ„Ÿå’Œåº”å¯¹å‹åŠ›ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" },
                            "emotional_supply_name": { "type": "STRING", "description": "æƒ…ç»ªä¸“å±è¡¥ç»™å“åç§°ï¼Œä¾‹å¦‚ï¼š'å†…å¿ƒå¹³é™é”šç‚¹'" },
                            "mental": { "type": "STRING", "description": "æ€ç»´ç®¡ç†æŒ‡å¼•ï¼Œå…³äºä¸“æ³¨åŠ›ã€æ·±åº¦å·¥ä½œå’Œä¼‘æ¯ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" },
                            "mental_supply_name": { "type": "STRING", "description": "æ€ç»´ä¸“å±è¡¥ç»™å“åç§°ï¼Œä¾‹å¦‚ï¼š'æ€ç»´å‡€åŒ–å™¨'" },
                            "spiritual": { "type": "STRING", "description": "æ„å¿—/ç›®çš„ç®¡ç†æŒ‡å¼•ï¼Œå…³äºä»·å€¼è§‚ã€ä½¿å‘½æ„Ÿå’Œäººç”Ÿæ„ä¹‰ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" },
                            "spiritual_supply_name": { "type": "STRING", "description": "æ„å¿—ä¸“å±è¡¥ç»™å“åç§°ï¼Œä¾‹å¦‚ï¼š'åŒ—ææ˜ŸæŒ‡å—é’ˆ'" }
                        },
                        "propertyOrdering": ["physical", "physical_supply_name", "emotional", "emotional_supply_name", "mental", "mental_supply_name", "spiritual", "spiritual_supply_name"]
                    },
                    "philosophy_questions": {
                        "type": "OBJECT",
                        "properties": {
                            "who_am_i": { "type": "STRING", "description": "å¯¹'æˆ‘æ˜¯è°'çš„æ·±åˆ»åæ€å’ŒæŒ‡å¼•ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" },
                            "where_from": { "type": "STRING", "description": "å¯¹'ä»å“ªé‡Œæ¥'çš„å›é¡¾ä¸å¯ç¤ºã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" },
                            "where_to": { "type": "STRING", "description": "å¯¹'è¦å»å“ªé‡Œ'çš„æ¢ç´¢ä¸è§„åˆ’ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" }
                        },
                        "propertyOrdering": ["who_am_i", "where_from", "where_to"] 
                    },
                    "golden_sentence": { "type": "STRING", "description": "æœ¬æ¬¡æ‰‹å†Œçš„æ€»ç»“æ€§ã€é¼“èˆäººå¿ƒçš„é‡‘å¥ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ã€‚" }
                },
                "required": ["character_profiles", "role_description", "talent_guidance", "mind_model", "model_application", "tool_guidance", "nlp_guidance", "energy_management", "philosophy_questions", "golden_sentence"]
            };

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema
                }
            };

            const options = {
                method: 'POST',
                mode: 'cors',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'x-goog-api-key': API_KEY
                },
                body: JSON.stringify(payload)
            };

            updateProgress("2/4: æ–‡æœ¬åˆ†æç”Ÿæˆä¸­..."); // Step 2 Progress Update
            
            const response = await fetchWithBackoff(GEMINI_API_URL, options);
            
            const jsonText = response.candidates?.[0]?.content?.parts?.[0]?.text;
            if (jsonText) {
                try {
                    return JSON.parse(jsonText);
                } catch (e) {
                    console.error("JSONè§£æé”™è¯¯:", e, jsonText);
                    throw new Error("AIè¿”å›çš„æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•ã€‚");
                }
            } else {
                throw new Error("AIæ–‡æœ¬ç”Ÿæˆå¤±è´¥ï¼Œæœªè¿”å›æœ‰æ•ˆå†…å®¹ã€‚");
            }
        }

        /**
         * æ­¥éª¤ 3: ç”Ÿæˆ AI è¡ŒåŠ¨è®¡åˆ’ (Gemini 2.5 Flash - Structured)
         */
        async function generateActionPlan(intro, roleDescription, energyManagement) {
            const systemPrompt = "ä½ æ˜¯ä¸€ä½é«˜æ•ˆçš„è¡ŒåŠ¨æ•™ç»ƒã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·çš„å½“å‰å›°å¢ƒå’Œè§’è‰²å¤©èµ‹ï¼Œä¸ºä»–ä»¬åˆ¶å®šä¸€ä¸ªå…·ä½“ã€å¯è¡Œã€ä¸”é«˜åº¦ä¸ªæ€§åŒ–çš„ä¸‰æ­¥è¡ŒåŠ¨è®¡åˆ’ï¼ˆé’ˆå¯¹æœªæ¥ä¸€å‘¨ï¼‰ã€‚è®¡åˆ’çš„æ¯ä¸€æ­¥éƒ½è¦æ¸…æ™°æ˜ç¡®ï¼Œä¸”ä¸è§’è‰²åˆ†æç›¸å…³ã€‚æ‰€æœ‰è¾“å‡ºå¿…é¡»ä¸¥æ ¼éµå®ˆæä¾›çš„JSON Schemaæ ¼å¼ã€‚";
            
            const energyManagementSummary = `
ä½“èƒ½ç®¡ç† (è¡¥ç»™å“: ${energyManagement.physical_supply_name}): ${marked.parse(energyManagement.physical).replace(/<[^>]*>/g, '')}
æƒ…ç»ªç®¡ç† (è¡¥ç»™å“: ${energyManagement.emotional_supply_name}): ${marked.parse(energyManagement.emotional).replace(/<[^>]*>/g, '')}
æ€ç»´ç®¡ç† (è¡¥ç»™å“: ${energyManagement.mental_supply_name}): ${marked.parse(energyManagement.mental).replace(/<[^>]*>/g, '')}
æ„å¿—ç®¡ç† (è¡¥ç»™å“: ${energyManagement.spiritual_supply_name}): ${marked.parse(energyManagement.spiritual).replace(/<[^>]*>/g, '')}
`;

            const userQuery = `è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯åˆ¶å®šä¸€ä¸ªä¸‰æ­¥è¡ŒåŠ¨è®¡åˆ’ï¼š
- **ç”¨æˆ·çš„å½“å‰å›°å¢ƒ/ç›®æ ‡**: ${intro}
- **è§’è‰²çš„æ ¸å¿ƒæè¿°**: ${roleDescription}
- **è§’è‰²çš„å››ç»´ç²¾åŠ›ç®¡ç†å»ºè®®**: ${energyManagementSummary}

è¯·æ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œç»™å‡ºä¸€ä¸ªæ ‡é¢˜ï¼Œåˆ—å‡º3ä¸ªå…·ä½“è¡ŒåŠ¨æ­¥éª¤ï¼Œå¹¶ä¸ºæ¯ä¸€æ­¥æ·»åŠ ä¸€ä¸ªâ€œæˆåŠŸè¡¡é‡æŒ‡æ ‡â€æˆ–â€œè¡ŒåŠ¨é¢‘ç‡â€ï¼ˆä¾‹å¦‚ï¼šæ¯å‘¨æ‰§è¡Œ 3 æ¬¡ï¼Œæˆ–å®Œæˆ 1 æ¬¡ï¼‰ã€‚`;

            const jsonSchema = {
                type: "OBJECT",
                properties: {
                    "plan_title": { "type": "STRING", "description": "è¡ŒåŠ¨è®¡åˆ’çš„æ ‡é¢˜ï¼Œæ¿€åŠ±äººå¿ƒï¼Œä¾‹å¦‚ï¼š'æ¢è·¯è€…ä¸€å‘¨è§‰é†’è®¡åˆ’'ã€‚" },
                    "steps": { 
                        "type": "ARRAY", 
                        "description": "ä¸‰ä¸ªå…·ä½“çš„è¡ŒåŠ¨æ­¥éª¤ï¼Œæ¯ä¸€æ­¥éƒ½æ˜¯ä¸€ä¸ªæ¸…æ™°çš„æŒ‡ä»¤å’Œå¯é‡åŒ–çš„ç›®æ ‡ã€‚",
                        "items": { 
                            "type": "OBJECT",
                            "properties": {
                                "action": { "type": "STRING", "description": "å…·ä½“çš„è¡ŒåŠ¨å†…å®¹ï¼Œå¦‚ï¼šæ¯å¤©æ—©ä¸Šå†™ 30 åˆ†é’Ÿæ— ç›®æ ‡è‡ªç”±å†™ä½œã€‚" },
                                "success_metric": { "type": "STRING", "description": "è¯¥è¡ŒåŠ¨çš„å¯é‡åŒ–æˆåŠŸè¡¡é‡æŒ‡æ ‡ï¼Œå¦‚ï¼šæœªæ¥ 7 å¤©å†…å®Œæˆ 5 æ¬¡ã€‚" }
                            }
                        }
                    }
                },
                "required": ["plan_title", "steps"]
            };

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema
                }
            };

            const options = {
                method: 'POST',
                mode: 'cors',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'x-goog-api-key': API_KEY
                },
                body: JSON.stringify(payload)
            };
            
            const response = await fetchWithBackoff(GEMINI_API_URL, options);
            
            const jsonText = response.candidates?.[0]?.content?.parts?.[0]?.text;
            if (jsonText) {
                try {
                    return JSON.parse(jsonText);
                } catch (e) {
                    console.error("JSONè§£æé”™è¯¯:", e, jsonText);
                    throw new Error("AIè¿”å›çš„è¡ŒåŠ¨è®¡åˆ’æ ¼å¼ä¸æ­£ç¡®ã€‚");
                }
            } else {
                throw new Error("AIè¡ŒåŠ¨è®¡åˆ’ç”Ÿæˆå¤±è´¥ã€‚");
            }
        }

        // NEW Helper: ç§»é™¤ Markdown è¾“å‡ºä¸­çš„å¤–å±‚ <p> æ ‡ç­¾ï¼Œç¡®ä¿åˆ—è¡¨å¯¹é½
        const stripPTags = (html) => html.replace(/^<p>(.*)<\/p>$/s, '$1');


        /**
         * æ­¥éª¤ 4: æ¸²æŸ“ç»“æœåˆ° UI
         */
        function renderResults(textData, imageURLs) {
            
            // æ¸²æŸ“å›¾ç‰‡è½®æ’­
            const track = document.getElementById('carousel-track');
            track.innerHTML = ''; // æ¸…ç©ºåŸæœ‰å›¾ç‰‡
            // FIXED: å¾ªç¯ totalSlides (2) æ¬¡
            imageURLs.forEach((url, index) => {
                const slide = document.createElement('div');
                slide.className = 'carousel-slide h-full';
                
                let imageHTML;
                // æ£€æŸ¥æ˜¯å¦ä¸ºé”™è¯¯å ä½å›¾
                if (url.includes('placehold.co')) {
                    imageHTML = `<div class="w-full h-full flex items-center justify-center bg-red-800 rounded-xl">
                                    <span class="text-white text-center p-4">å›¾åƒç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ£€æŸ¥ç½‘ç»œã€‚</span>
                                 </div>`;
                } else {
                    imageHTML = `<img src="${url}" alt="è§’è‰²å½¢è±¡ ${index === 0 ? 'å¹»æƒ³' : 'ç°å®'} å½¢æ€" class="w-full h-full object-cover rounded-xl">`;
                }

                slide.innerHTML = sanitizeHTML(imageHTML);
                track.appendChild(slide);
            });
            currentSlide = 0; // é‡ç½®è½®æ’­å›¾åˆ°ç¬¬ä¸€å¼ 
            updateCarousel(); // ç«‹å³æ›´æ–°ä½ç½®

            // ç¡®ä¿è¾“å…¥è¡¨å•è¢«å¼ºåˆ¶éšè—
            hideContainer(inputFormContainer);
            
            // --- NEW: æ¸²æŸ“åŒè§’è‰²ä¿¡æ¯ ---
            const fantasy = textData.character_profiles.fantasy_role;
            const realistic = textData.character_profiles.realistic_persona;

            document.getElementById('fantasy-role-name').textContent = fantasy.name;
            document.getElementById('fantasy-role-trait').textContent = fantasy.trait;
            document.getElementById('fantasy-fit-percent').textContent = `${fantasy.fit_percentage}%`;
            document.getElementById('fantasy-fit-bar').style.width = `${fantasy.fit_percentage}%`;
            
            document.getElementById('realistic-role-name').textContent = realistic.name;
            document.getElementById('realistic-role-name').textContent = realistic.name;
            document.getElementById('realistic-fit-percent').textContent = `${realistic.fit_percentage}%`;
            document.getElementById('realistic-fit-bar').style.width = `${realistic.fit_percentage}%`;
            // --- END NEW ---

            document.getElementById('role-description-display').innerHTML = sanitizeHTML(marked.parse(textData.role_description));
            document.getElementById('golden-sentence-display').innerHTML = sanitizeHTML(marked.parse(textData.golden_sentence));

            // æ¸²æŸ“ NLP å…­å±‚ (æ·»åŠ XSSé˜²æŠ¤)
            document.getElementById('nlp-environment').innerHTML = sanitizeHTML(`<strong>ğŸŒ ç¯å¢ƒï¼š</strong> ${marked.parse(textData.nlp_guidance.environment)}`);
            document.getElementById('nlp-behavior').innerHTML = sanitizeHTML(`<strong>ğŸƒ è¡Œä¸ºï¼š</strong> ${marked.parse(textData.nlp_guidance.behavior)}`);
            document.getElementById('nlp-capacity').innerHTML = sanitizeHTML(`<strong>ğŸ§  èƒ½åŠ›ï¼š</strong> ${marked.parse(textData.nlp_guidance.capacity)}`);
            document.getElementById('nlp-belief-value').innerHTML = sanitizeHTML(`<strong>â¤ï¸ ä¿¡å¿µä¸ä»·å€¼è§‚ï¼š</strong> ${marked.parse(textData.nlp_guidance.belief_value)}`);
            document.getElementById('nlp-identity').innerHTML = sanitizeHTML(`<strong>ğŸ‘¤ èº«ä»½ï¼š</strong> ${marked.parse(textData.nlp_guidance.identity)}`);
            document.getElementById('nlp-mission').innerHTML = sanitizeHTML(`<strong>âœ¨ ç²¾ç¥/ä½¿å‘½ï¼š</strong> ${marked.parse(textData.nlp_guidance.mission)}`);

            // æ¸²æŸ“ ç²¾åŠ›ç®¡ç† (å››ç»´+è¡¥ç»™å“åç§°) (æ·»åŠ XSSé˜²æŠ¤)
            document.getElementById('energy-physical').innerHTML = sanitizeHTML(`<strong>ğŸ’ª ä½“èƒ½ (<span class="text-accent">${textData.energy_management.physical_supply_name}</span>)ï¼š</strong> ${marked.parse(textData.energy_management.physical)}`);
            document.getElementById('energy-emotional').innerHTML = sanitizeHTML(`<strong>ğŸ’– æƒ…ç»ª (<span class="text-accent">${textData.energy_management.emotional_supply_name}</span>)ï¼š</strong> ${marked.parse(textData.energy_management.emotional)}`);
            document.getElementById('energy-mental').innerHTML = sanitizeHTML(`<strong>ğŸ§  æ€ç»´ (<span class="text-accent">${textData.energy_management.mental_supply_name}</span>)ï¼š</strong> ${marked.parse(textData.energy_management.mental)}`);
            document.getElementById('energy-spiritual').innerHTML = sanitizeHTML(`<strong>ğŸ”¥ æ„å¿— (<span class="text-accent">${textData.energy_management.spiritual_supply_name}</span>)ï¼š</strong> ${marked.parse(textData.energy_management.spiritual)}`);

            // æ¸²æŸ“ å“²å­¦ä¸‰é—® (æ·»åŠ XSSé˜²æŠ¤)
            document.getElementById('who-am-i').innerHTML = sanitizeHTML(`<strong>æˆ‘æ˜¯è°ï¼Ÿ</strong> ${marked.parse(textData.philosophy_questions.who_am_i)}`);
            document.getElementById('where_from').innerHTML = sanitizeHTML(`<strong>ä»å“ªé‡Œæ¥ï¼Ÿ</strong> ${marked.parse(textData.philosophy_questions.where_from)}`);
            document.getElementById('where_to').innerHTML = sanitizeHTML(`<strong>è¦å»å“ªé‡Œï¼Ÿ</strong> ${marked.parse(textData.philosophy_questions.where_to)}`);
            
            // æ¸²æŸ“ å¤©èµ‹æŒ‡å¼• (æ·»åŠ XSSé˜²æŠ¤)
            document.getElementById('talent-strengths').innerHTML = sanitizeHTML(`<strong>âœ… æ ¸å¿ƒä¼˜åŠ¿ï¼š</strong> ${marked.parse(textData.talent_guidance.strengths)}`);
            document.getElementById('talent-shadow').innerHTML = sanitizeHTML(`<strong>âš ï¸ å¤©èµ‹é™·é˜± (é˜´å½±é¢)ï¼š</strong> ${marked.parse(textData.talent_guidance.shadow_trait)}`);
            document.getElementById('talent-weaknesses').innerHTML = sanitizeHTML(`<strong>âŒ æ½œåœ¨åŠ£åŠ¿ï¼š</strong> ${marked.parse(textData.talent_guidance.weaknesses)}`);

            // æ¸²æŸ“ æ€ç»´æ¨¡å‹ (æ·»åŠ XSSé˜²æŠ¤)
            document.getElementById('mind-model-display').innerHTML = sanitizeHTML(`<strong>ğŸ’¡ ä¸“å±æ€ç»´æ¨¡å‹ï¼š</strong> ${marked.parse(textData.mind_model)}`);
            document.getElementById('model-application-display').innerHTML = sanitizeHTML(`<strong>ğŸ“– å®æ“åº”ç”¨åœºæ™¯ï¼š</strong> ${marked.parse(textData.model_application)}`);

            // æ¸²æŸ“ å·¥å…·æŒ‡å¼• (æ·»åŠ XSSé˜²æŠ¤)
            document.getElementById('tool-guidance-display').innerHTML = sanitizeHTML(`<strong>ğŸ› ï¸ æ¨èå·¥å…·ï¼š</strong> ${marked.parse(textData.tool_guidance)}`);

            loadingArea.classList.add('hidden');
            showContainer(resultCard);
            
            // ç»‘å®šè¡ŒåŠ¨è®¡åˆ’æŒ‰é’®äº‹ä»¶ï¼Œå¹¶æ¸…ç©ºä¸Šæ¬¡çš„è®¡åˆ’ç»“æœ
            document.getElementById('generate-plan-btn').onclick = handleGeneratePlan; 
            document.getElementById('action-plan-result').classList.add('hidden');
            document.getElementById('plan-loading-message').classList.add('hidden');
            
            resultCard.scrollIntoView({ behavior: 'smooth' });
        }
        
        // --- è¡ŒåŠ¨è®¡åˆ’é€»è¾‘ (å·²æ›´æ–°ä¸ºæ–°çš„ JSON ç»“æ„) ---
        function renderActionPlan(planData) {
            document.getElementById('plan-title-display').textContent = planData.plan_title;
            const planList = document.getElementById('plan-list');
            planList.innerHTML = ''; 
            
            planData.steps.forEach((step) => {
                const li = document.createElement('li');
                // FIX: å¼ºåˆ¶ä½¿ç”¨ mb-4 å¢åŠ è¡ŒåŠ¨è®¡åˆ’çš„è¡Œé—´è·
                li.className = 'flex items-start mb-4'; 
                // FIX: ä½¿ç”¨ stripPTags ç¡®ä¿è¡ŒåŠ¨å†…å®¹å¹²å‡€
                li.innerHTML = sanitizeHTML(`
                    <span class="inline-block w-4 h-4 mr-2 mt-1 rounded-full bg-accent flex-shrink-0"></span>
                    <span class="flex-grow">
                        ${stripPTags(marked.parse(step.action))} 
                        <span class="text-sm text-gray-500 block">(${stripPTags(marked.parse(step.success_metric))})</span>
                    </span>
                `);
                planList.appendChild(li);
            });
        }
        
        async function handleGeneratePlan() {
            if (!latestTextData || !form.elements.intro.value) {
                showCustomMessage("æç¤º", "ç¼ºå°‘è§’è‰²ä¿¡æ¯æˆ–å›°å¢ƒæè¿°ï¼Œæ— æ³•ç”Ÿæˆè¡ŒåŠ¨è®¡åˆ’ã€‚");
                return;
            }

            const planBtn = document.getElementById('generate-plan-btn');
            const planResult = document.getElementById('action-plan-result');
            const planLoading = document.getElementById('plan-loading-message');

            planBtn.disabled = true;
            planResult.classList.add('hidden');
            planLoading.classList.remove('hidden');
            planLoading.textContent = "æ­£åœ¨ä¸ºä½ åˆ¶å®šä¸‹ä¸€æ­¥çš„è¡ŒåŠ¨è·¯çº¿...";
            
            const intro = form.elements.intro.value;
            const roleDescription = latestTextData.role_description;
            const energyManagement = latestTextData.energy_management; 
            
            try {
                const planData = await generateActionPlan(intro, roleDescription, energyManagement);
                renderActionPlan(planData);
                planLoading.classList.add('hidden');
                planResult.classList.remove('hidden');
            } catch (error) {
                console.error("è¡ŒåŠ¨è®¡åˆ’ç”Ÿæˆå¤±è´¥:", error);
                showError(`è¡ŒåŠ¨è®¡åˆ’ç”Ÿæˆå¤±è´¥: ${error.message}`);
                planLoading.classList.add('hidden');
            } finally {
                planBtn.disabled = false;
            }
        }


        /**
         * ä¸»æ§å‡½æ•°
         */
        async function generateCharacter(event) {
            event.preventDefault();
            
            // è¡¨å•æ ¡éªŒ
            if (!validateForm()) {
                return;
            }

            // æ ¡éªŒå¹¶åŠ è½½æµè§ˆå™¨å¯†é’¥
            API_KEY = (localStorage.getItem('gemini_api_key') || API_KEY).trim();
            const v = validateApiKey(API_KEY);
            if (!v.ok) {
                showError(`æˆæƒé”™è¯¯ï¼š${v.reason}ã€‚è¯·åœ¨ AI Studio çš„æµè§ˆå™¨å¯†é’¥è®¾ç½®ä¸­é…ç½®ï¼Œå¹¶åœ¨å…è®¸åŸŸåä¸­æ·»åŠ  http://localhostã€‚`);
                submitBtn.disabled = false;
                return;
            }
            
            // é‡ç½®è¿›åº¦
            currentProcessStep = 0;
            progressBar.style.width = '0%';
            
            // éšè—è¡¨å•ï¼Œæ˜¾ç¤ºåŠ è½½
            hideContainer(inputFormContainer);
            hideContainer(resultCard);
            loadingArea.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            submitBtn.disabled = true;

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // 1. è¯»å–ä¸Šä¼ å›¾ç‰‡ä¸º Base64
            const photoFile = photoInput.files[0];
            try {
                // Step 1 Progress Update
                updateProgress("1/4: æ­£åœ¨è¯»å–ç…§ç‰‡å’Œå‡†å¤‡æ–‡æœ¬æ•°æ®...");
                
                if (photoFile) {
                    // NEW: ä¸Šä¼ æ ¡éªŒ - ç±»å‹ä¸å¤§å°
                    if (!CONFIG.upload.allowedMimeTypes.includes(photoFile.type)) {
                        showCustomMessage("æç¤º", "ä»…æ”¯æŒä¸Šä¼  PNG/JPEG/WEBP å›¾ç‰‡ã€‚");
                        submitBtn.disabled = false;
                        loadingArea.classList.add('hidden');
                        showContainer(inputFormContainer);
                        return;
                    }
                    if (photoFile.size > CONFIG.upload.maxBytes) {
                        showCustomMessage("æç¤º", "å›¾ç‰‡å¤§å°ä¸è¶…è¿‡ 3MBã€‚");
                        submitBtn.disabled = false;
                        loadingArea.classList.add('hidden');
                        showContainer(inputFormContainer);
                        return;
                    }
                    uploadedImageBase64 = await readFileAsBase64(photoFile);
                    uploadedImageMimeType = photoFile.type; 
                } else {
                    uploadedImageBase64 = null;
                    uploadedImageMimeType = null;
                }
            } catch (error) {
                console.error("ç…§ç‰‡è¯»å–å¤±è´¥:", error);
                showError("ç…§ç‰‡è¯»å–å¤±è´¥ï¼è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚");
                submitBtn.disabled = false;
                
                loadingArea.classList.add('hidden');
                showContainer(inputFormContainer);
                
                return;
            }

            try {
                // 2. ç”Ÿæˆæ–‡æœ¬
                const textData = await generateText(data);
                latestTextData = textData; // å­˜å‚¨æ–‡æœ¬æ•°æ®
                
                // ä½¿ç”¨å¹»æƒ³è§’è‰²çš„åç§°å’Œç°å®è§’è‰²çš„åç§°æ¥ç”Ÿæˆå›¾åƒ
                const fantasyRoleName = textData.character_profiles.fantasy_role.name;
                const realisticRoleName = textData.character_profiles.realistic_persona.name;

                // 3. ç”Ÿæˆä¸¤å¼ å›¾ç‰‡
                const imageURLs = await generateTwoImages(
                    fantasyRoleName, 
                    realisticRoleName, 
                    uploadedImageBase64,
                    uploadedImageMimeType
                );
                
                // 4. æ¸²æŸ“ç»“æœ
                renderResults(textData, imageURLs);
                

            } catch (error) {
                console.error("ç”Ÿæˆå¤±è´¥:", error);
                loadingMessage.textContent = "ç”Ÿæˆå¤±è´¥ï¼";
                
                // æ£€æŸ¥æ˜¯å¦ä¸º 401 é”™è¯¯ï¼Œå¹¶ç»™å‡ºæ›´æ˜ç¡®çš„æç¤º
                if ((error.message || '').includes("401")) {
                    showError("é”™è¯¯ä¿¡æ¯: æˆæƒå¤±è´¥ (401)ã€‚è¯·æ£€æŸ¥æ‚¨çš„ Gemini API Key æ˜¯å¦æœ‰æ•ˆæˆ–å·²æ­£ç¡®é…ç½®ã€‚");
                } else {
                    showError(`é”™è¯¯ä¿¡æ¯: ${error.message}. è¯·æ£€æŸ¥è¾“å…¥å¹¶é‡è¯•ã€‚`);
                }

                loadingArea.classList.add('hidden');
                showContainer(inputFormContainer); // å¤±è´¥æ—¶è¿”å›è¾“å…¥é¡µ
                
            } finally {
                submitBtn.disabled = false;
            }
        }

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        form.addEventListener('submit', generateCharacter);
        
        // å ä½å‡½æ•°ï¼šæ›¿æ¢ alert() çš„è‡ªå®šä¹‰æ¶ˆæ¯æ¡†
        function showCustomMessage(title, message) {
            console.warn(`${title}: ${message}`);
            // åœ¨è¡¨å•é¡¶éƒ¨æ·»åŠ ä¸€ä¸ªä¸´æ—¶çš„æ¶ˆæ¯ div
            const existingAlert = document.querySelector('#input-form-container > .bg-red-800');
            if (existingAlert) existingAlert.remove();
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'bg-red-800 text-white p-3 rounded-xl mb-4 text-sm';
            alertDiv.textContent = `${title}: ${message}`;
            const formContainer = document.getElementById('input-form-container');
            formContainer.insertBefore(alertDiv, formContainer.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // NEW: APIå¯†é’¥è®¾ç½®ç›¸å…³å‡½æ•°
        function toggleApiSettings() {
            const panel = document.getElementById('api-settings-panel');
            const input = document.getElementById('api-key-input');
            const domainElement = document.getElementById('current-domain');
            
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                // æ˜¾ç¤ºå½“å‰åŸŸå
                domainElement.textContent = window.location.origin;
                // åŠ è½½å½“å‰ä¿å­˜çš„APIå¯†é’¥
                const savedKey = localStorage.getItem('gemini_api_key') || '';
                input.value = savedKey;
                updateApiKeyStatus(savedKey);
            } else {
                panel.classList.add('hidden');
            }
        }

        function updateApiKeyStatus(apiKey) {
            const statusDiv = document.getElementById('api-key-status');
            const validation = validateApiKey(apiKey);
            
            if (!apiKey) {
                statusDiv.innerHTML = '<span class="text-gray-400">è¯·è¾“å…¥APIå¯†é’¥</span>';
            } else if (validation.ok) {
                statusDiv.innerHTML = '<span class="text-green-400">âœ“ å¯†é’¥æ ¼å¼æ­£ç¡®</span>';
            } else {
                statusDiv.innerHTML = `<span class="text-red-400">âœ— ${validation.reason}</span>`;
            }
        }

        async function testApiKey() {
            const input = document.getElementById('api-key-input');
            const testBtn = document.getElementById('test-api-key-btn');
            const statusDiv = document.getElementById('api-key-status');
            
            const apiKey = input.value.trim();
            if (!apiKey) {
                statusDiv.innerHTML = '<span class="text-red-400">è¯·å…ˆè¾“å…¥APIå¯†é’¥</span>';
                return;
            }

            testBtn.disabled = true;
            testBtn.textContent = 'æµ‹è¯•ä¸­...';
            statusDiv.innerHTML = '<span class="text-blue-400">ğŸ”„ æ­£åœ¨æµ‹è¯•è¿æ¥...</span>';

            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            console.log('ğŸ”‘ æµ‹è¯•APIå¯†é’¥:', apiKey.substring(0, 20) + '...');
            console.log('ğŸŒ å½“å‰åŸŸå:', window.location.origin);
            console.log('ğŸ“¡ æµ‹è¯•ç«¯ç‚¹:', CONFIG.endpoints.text);

            try {
                // å‘é€ä¸€ä¸ªç®€å•çš„æµ‹è¯•è¯·æ±‚
                const response = await fetch(CONFIG.endpoints.text, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-goog-api-key': apiKey
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: "æµ‹è¯•è¿æ¥" }]
                        }]
                    })
                });

                console.log('ğŸ“¡ APIæµ‹è¯•å“åº”:', response.status, response.statusText);

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… APIæµ‹è¯•æˆåŠŸ:', data);
                    statusDiv.innerHTML = '<span class="text-green-400">âœ“ è¿æ¥æˆåŠŸï¼APIå¯†é’¥æœ‰æ•ˆ</span>';
                } else {
                    const errorData = await response.text();
                    console.error('âŒ APIæµ‹è¯•é”™è¯¯è¯¦æƒ…:', errorData);
                    
                    let errorMessage = '';
                    try {
                        const errorJson = JSON.parse(errorData);
                        if (errorJson.error && errorJson.error.message) {
                            errorMessage = errorJson.error.message;
                        }
                    } catch (e) {
                        errorMessage = errorData;
                    }
                    
                    if (response.status === 400) {
                        statusDiv.innerHTML = `<span class="text-red-400">âœ— APIå¯†é’¥æ— æ•ˆæˆ–æ ¼å¼é”™è¯¯<br><small class="text-gray-400">${errorMessage}</small></span>`;
                    } else if (response.status === 403) {
                        statusDiv.innerHTML = `<span class="text-red-400">âœ— åŸŸåæœªæˆæƒï¼Œè¯·åœ¨AI Studioä¸­æ·»åŠ ï¼š<br><code class="bg-gray-600 px-1 rounded text-xs">${window.location.origin}</code><br><small class="text-gray-400">${errorMessage}</small></span>`;
                    } else {
                        statusDiv.innerHTML = `<span class="text-red-400">âœ— è¿æ¥å¤±è´¥ (${response.status})<br><small class="text-gray-400">${errorMessage}</small></span>`;
                    }
                }
            } catch (error) {
                console.error('ğŸš« APIæµ‹è¯•å¤±è´¥:', error);
                statusDiv.innerHTML = `<span class="text-red-400">âœ— ç½‘ç»œè¿æ¥å¤±è´¥<br><small class="text-gray-400">${error.message}</small></span>`;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'æµ‹è¯•è¿æ¥';
            }
        }

        function saveApiKey() {
            const input = document.getElementById('api-key-input');
            const saveBtn = document.getElementById('save-api-key-btn');
            const statusDiv = document.getElementById('api-key-status');
            
            const apiKey = input.value.trim();
            const validation = validateApiKey(apiKey);
            
            if (!validation.ok) {
                statusDiv.innerHTML = `<span class="text-red-400">âœ— ${validation.reason}</span>`;
                return;
            }

            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('gemini_api_key', apiKey);
            
            // æ›´æ–°å…¨å±€API_KEYå˜é‡
            API_KEY = apiKey;
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            statusDiv.innerHTML = '<span class="text-green-400">âœ“ APIå¯†é’¥å·²ä¿å­˜</span>';
            saveBtn.textContent = 'å·²ä¿å­˜';
            
            setTimeout(() => {
                saveBtn.textContent = 'ä¿å­˜å¯†é’¥';
                toggleApiSettings(); // å…³é—­é¢æ¿
            }, 1500);
        }

        function diagnoseApiKey() {
            const input = document.getElementById('api-key-input');
            const diagnosisPanel = document.getElementById('api-diagnosis');
            const diagnosisContent = document.getElementById('diagnosis-content');
            const diagnoseBtn = document.getElementById('diagnose-api-btn');
            
            const apiKey = input.value.trim();
            
            diagnoseBtn.disabled = true;
            diagnoseBtn.textContent = 'è¯Šæ–­ä¸­...';
            diagnosisPanel.classList.remove('hidden');
            
            // æ”¶é›†è¯Šæ–­ä¿¡æ¯
            const diagnostics = [];
            
            // 1. åŸºæœ¬ä¿¡æ¯
            diagnostics.push(`<div class="flex justify-between"><span>å½“å‰åŸŸå:</span><span class="text-blue-300">${window.location.origin}</span></div>`);
            diagnostics.push(`<div class="flex justify-between"><span>APIå¯†é’¥é•¿åº¦:</span><span class="text-blue-300">${apiKey.length} å­—ç¬¦</span></div>`);
            
            // 2. æ ¼å¼éªŒè¯
            const validation = validateApiKey(apiKey);
            if (validation.ok) {
                diagnostics.push(`<div class="flex justify-between"><span>å¯†é’¥æ ¼å¼:</span><span class="text-green-300">âœ“ æ­£ç¡®</span></div>`);
            } else {
                diagnostics.push(`<div class="flex justify-between"><span>å¯†é’¥æ ¼å¼:</span><span class="text-red-300">âœ— ${validation.reason}</span></div>`);
            }
            
            // 3. æœ¬åœ°å­˜å‚¨çŠ¶æ€
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                const isSame = savedKey === apiKey;
                diagnostics.push(`<div class="flex justify-between"><span>æœ¬åœ°å­˜å‚¨:</span><span class="text-${isSame ? 'green' : 'yellow'}-300">${isSame ? 'âœ“ å·²ä¿å­˜' : 'âš  ä¸è¾“å…¥ä¸åŒ'}</span></div>`);
            } else {
                diagnostics.push(`<div class="flex justify-between"><span>æœ¬åœ°å­˜å‚¨:</span><span class="text-gray-300">æœªä¿å­˜</span></div>`);
            }
            
            // 4. ç½‘ç»œç¯å¢ƒæ£€æŸ¥
            diagnostics.push(`<div class="flex justify-between"><span>ç”¨æˆ·ä»£ç†:</span><span class="text-blue-300">${navigator.userAgent.includes('Chrome') ? 'Chrome' : navigator.userAgent.includes('Firefox') ? 'Firefox' : 'å…¶ä»–'}</span></div>`);
            diagnostics.push(`<div class="flex justify-between"><span>åè®®:</span><span class="text-blue-300">${window.location.protocol}</span></div>`);
            
            // 5. å¸¸è§é—®é¢˜æ£€æŸ¥
            const commonIssues = [];
            if (!apiKey.startsWith('gen-lang-client-')) {
                commonIssues.push('âŒ å¯†é’¥æ ¼å¼é”™è¯¯ï¼Œåº”ä½¿ç”¨æµè§ˆå™¨å¯†é’¥ï¼ˆgen-lang-client-å¼€å¤´ï¼‰');
            }
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                commonIssues.push('âŒ éHTTPSåè®®å¯èƒ½å¯¼è‡´APIè°ƒç”¨å¤±è´¥');
            }
            if (apiKey.length < 30) {
                commonIssues.push('âŒ å¯†é’¥é•¿åº¦å¼‚å¸¸ï¼Œå¯èƒ½ä¸å®Œæ•´');
            }
            
            if (commonIssues.length > 0) {
                diagnostics.push('<div class="border-t border-gray-600 pt-2 mt-2">');
                diagnostics.push('<div class="text-yellow-300 font-medium mb-1">å‘ç°çš„é—®é¢˜:</div>');
                commonIssues.forEach(issue => {
                    diagnostics.push(`<div class="text-red-300 text-xs">${issue}</div>`);
                });
                diagnostics.push('</div>');
            } else {
                diagnostics.push('<div class="border-t border-gray-600 pt-2 mt-2">');
                diagnostics.push('<div class="text-green-300 font-medium">âœ“ æœªå‘ç°æ˜æ˜¾é—®é¢˜</div>');
                diagnostics.push('</div>');
            }
            
            // 6. å»ºè®®æ“ä½œ
            diagnostics.push('<div class="border-t border-gray-600 pt-2 mt-2">');
            diagnostics.push('<div class="text-blue-300 font-medium mb-1">å»ºè®®æ“ä½œ:</div>');
            diagnostics.push('<div class="text-xs">1. ç¡®ä¿åœ¨Google AI Studioä¸­æ·»åŠ äº†å½“å‰åŸŸå</div>');
            diagnostics.push('<div class="text-xs">2. ä½¿ç”¨"æµ‹è¯•è¿æ¥"éªŒè¯å¯†é’¥æœ‰æ•ˆæ€§</div>');
            diagnostics.push('<div class="text-xs">3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯</div>');
            diagnostics.push('</div>');
            
            diagnosisContent.innerHTML = diagnostics.join('');
            
            setTimeout(() => {
                diagnoseBtn.disabled = false;
                diagnoseBtn.textContent = 'è¯Šæ–­';
            }, 1000);
        }

        // ä¸ºAPIå¯†é’¥è¾“å…¥æ¡†æ·»åŠ å®æ—¶éªŒè¯
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('api-key-input');
            if (input) {
                input.addEventListener('input', function() {
                    updateApiKeyStatus(this.value.trim());
                });
            }
        });
        
        window.onload = () => {
             // é»˜è®¤æŠ˜å æ‰€æœ‰æŒ‡å¼•å†…å®¹
             // FIX: ç¡®ä¿åœ¨åˆå§‹åŒ–æ—¶è¿™äº›å…ƒç´ æ˜¯éšè—çš„ï¼Œè€Œä¸æ˜¯ active
             document.getElementById('nlp-content').classList.remove('active');
             document.getElementById('energy-content').classList.remove('active');
             document.getElementById('philosophy-content').classList.remove('active');
             document.getElementById('talent-content').classList.remove('active'); 
             document.getElementById('model-content').classList.remove('active'); 
             document.getElementById('tool-content').classList.remove('active'); 

             document.getElementById('nlp-toggle').textContent = '+';
             document.getElementById('energy-toggle').textContent = '+';
             document.getElementById('philosophy-toggle').textContent = '+';
             document.getElementById('talent-toggle').textContent = '+';
             document.getElementById('model-toggle').textContent = '+';
             document.getElementById('tool-toggle').textContent = '+';


             // å¼ºåˆ¶åˆå§‹çŠ¶æ€ä¸ºè¾“å…¥é¡µæ˜¾ç¤ºï¼Œç»“æœé¡µéšè—
             hideContainer(resultCard); // ç¡®ä¿ç»“æœå¡ç‰‡æ˜¯éšè—çš„
             showContainer(inputFormContainer);
             
             updateCarousel(); // åˆå§‹åŒ–è½®æ’­å›¾ä½ç½®
        };

    </script>
</body>
</html>
